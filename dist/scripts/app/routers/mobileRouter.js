define(["jquery","parse","pretty","jscookie","moment","../models/CategoryModel","../collections/CategoriesCollection","../views/CategoryView","../views/CharactersListView","../models/Vampire","../collections/Vampires","../views/CharacterView","../views/SimpleTraitCategoryView","../views/SimpleTraitNewView","../models/SimpleTrait","../views/SimpleTraitChangeView","../models/VampireCreation","../views/CharacterCreateView","../views/CharacterNewView","../views/CharacterPrintView","../views/CharacterCostsView","../views/SimpleTextNewView","../views/SimpleTraitSpecializationView","../views/CharacterLogView","../views/CharacterHistoryView","../views/SignupView","../views/LoginView","../views/CharacterExperienceView","../views/UserSettingsProfileView","../views/CharacterPortraitView","../views/TroupeCharacterRelationshipsNetworkView","../views/CharacterDeleteView","../views/PlayerOptionsView","../views/TroupeNewView","../views/TroupesListView","../views/TroupeView","../views/UsersView","../views/TroupeEditStaffView","../models/Troupe","../helpers/PromiseFailReport","../views/TroupePortraitView","text!../templates/footer.html","../views/AdministrationUserView","../views/PasswordReset","../views/CharacterApprovalView","../helpers/InjectAuthData","../views/AdministrationUserView","../collections/Patronages","../views/PatronagesView","../views/PatronageView","../collections/Users","../models/Patronage","../helpers/UserWreqr","../views/CharactersSummarizeListView","../views/CharacterRenameView","../views/SimpleTraitNewSpecializationView","../views/CharacterCreateSimpleTraitNewView","../views/DescriptionsView","../models/Werewolf"],function(e,t,a,r,i,n,o,c,s,h,l,u,g,p,d,w,m,f,b,v,V,P,y,k,T,H,C,S,U,x,z,N,Q,I,A,L,j,E,R,q,D,J,O,M,W,B,F,G,K,X,Y,Z,$,ee,te,ae,re,ie,ne){var oe=t.Router.extend({initialize:function(){this._character=null,_.bindAll(this,"get_character"),this.animalsView=new c({el:"#animals",collection:new o([],{type:"animals"})}),this.colorsView=new c({el:"#colors",collection:new o([],{type:"colors"})}),this.vehiclesView=new c({el:"#vehicles",collection:new o([],{type:"vehicles"})}),this.characters=new s({el:"#characters-all",collection:new l}),this.troupeCharacters=new s({el:"#troupe-characters-all",collection:new l}),this.character=new u({el:"#character"}),this.simpleTraitCategoryView=new g({el:"#simpletraitcategory-all"}),this.simpleTraitNewView=new p({el:"#simpletrait-new > div[role='main']"}),this.simpleTraitChangeView=new w({el:"#simpletrait-change"}),this.simpleTextNewView=new P({el:"#simpletext-new"}),this.simpleTraitSpecializationView=new y({el:"#simpletrait-specialization"}),this.simpleTraitNewSpecializationView=new ae({el:"#simpletrait-new-specialization"}),this.characterCreateSimpleTraitNewView=new re({el:"#character-create-simpletrait-new"}),this.characterCreateView=new f({el:"#character-create"}),this.characterNewView=new b({el:"#character-new-form"}),this.characterPrintView=new v({el:"#printable-sheet"}),this.characterCostsView=new V({el:"#character-costs"}),this.characterLogView=new k({el:"#character-log"}),this.characterHistoryView=new T({el:"#character-history"}),this.characterExperienceView=new S({el:"#experience-notations-all"}),this.characterPortraitView=new x({el:"#character-portrait"}),this.characterDeleteView=new N({el:"#character-delete"}),this.characterApprovalView=new W({el:"#character-approval"}),this.loginView=new C,this.signupView=new H,this.troupeCharacterRelationshipsNetworkView=new z({el:"#troupe-character-relationships-network"}),t.history.start()},routes:{"":"home",start:"home",logout:"logout",signup:"signup",reset:"resetpassword",profile:"profile","category?:type":"category","victims?:type":"victims","characters?:type":"characters","character?:id":"character","simpletraits/:category/:cid/:type":"simpletraits","simpletrait/:category/:cid/:bid":"simpletrait","simpletrait/specialize/:category/:cid/:bid":"simpletraitspecialize","simpletrait/spacer/:category/:cid/:name/:value/:free_value/new":"simpletraitnew","simpletrait/specialize/:category/:cid/:name/:value/:free_value/new":"simpletrait_new_specialize","simpletext/:category/:target/:cid/pick":"simpletextpick","charactercreate/:cid":"charactercreate","charactercreate/simpletraits/:category/:cid/pick/:i":"charactercreatepicksimpletrait","charactercreate/simpletraits/:category/:cid/unpick/:stid/:i":"charactercreateunpicksimpletrait","charactercreate/simpletraits/:category/:cid/specialize/:stid/:i":"charactercreatespecializesimpletrait","charactercreate/simpletext/:category/:target/:cid/pick":"charactercreatepicksimpletext","charactercreate/complete/:cid":"charactercreatecomplete",characternew:"characternew","character/:cid/print":"characterprint","character/:cid/costs":"charactercosts","character/:cid/log/:start/:changeBy":"characterlog","character/:cid/history/:id":"characterhistory","character/:cid/portrait":"characterportrait","character/:cid/delete":"characterdelete","character/:cid/troupes":"character_list_troupes","character/:cid/troupes/leave":"character_pick_troupe_to_leave","character/:cid/troupes/join":"character_pick_troupe_to_join","character/:cid/troupe/:tid/join":"character_join_troupe","character/:cid/troupe/:tid/leave":"character_leave_troupe","character/:cid/troupe/:tid/show":"character_show_troupe","character/:cid/approval":"characterapproval","character/:cid/rename":"characterrename","character/:cid/experience/:start/:changeBy":"characterexperience","troupe/new":"troupenew",troupes:"troupes","troupe/:id":"troupe","troupe/:id/staff/add":"troupeaddstaff","troupe/:id/staff/edit/:uid":"troupeeditstaff","troupe/:id/characters/:type":"troupecharacters","troupe/:id/characters/summarize/:type":"troupesummarizecharacters","troupe/:id/characters/relationships/network":"troupe_relationship_network","troupe/:id/character/:cid":"troupe_character","troupe/:id/portrait":"troupe_portrait",administration:"administration","administration/characters/all":"administration_characters_all","administration/character/:id":"administration_character","administration/users/all":"administration_users","administration/user/:id":"administration_user","administration/patronages/user/:id":"administration_user_patronages","administration/patronages":"administration_patronages","administration/patronage/:id":"administration_patronage","administration/patronages/new":"administration_patronage_new","administration/patronages/new/:userid":"administration_patronage_new","administration/descriptions":"administration_descriptions"},home:function(){var a=this;this.enforce_logged_in().then(function(){var e=new t.Query(t.Role).equalTo("users",t.User.current());return e.count()}).then(function(e){var a=t.User.current();return 0<e?a.set("storytellerinterface",!0):a.set("storytellerinterface",!1),B(a),a.save()}).then(function(){a.playerOptionsView=a.playerOptionsView||new Q({el:"#player-options"}).render(),e.mobile.changePage("#player-options",{reverse:!1,changeHash:!1})}).fail(q)},logout:function(){t.User.logOut().always(function(){return hello("facebook").logout()}).always(function(){window.location.hash="",window.location.reload()})},signup:function(){t.User.current()?window.location.hash="":e.mobile.changePage("#signup",{reverse:!1,changeHash:!1})},resetpassword:function(){var t=this;t.resetPasswordView=t.resetPasswordView||new M({el:"#user-reset-password"}),t.resetPasswordView.render(),e.mobile.changePage("#user-reset-password",{reverse:!1,changeHash:!1})},profile:function(){var t=this;t.enforce_logged_in().then(function(){return $.get_users()}).then(function(){t.set_back_button("#"),t.userSettingsProfileView=t.userSettingsProfileView||(new U).setup(),e.mobile.changePage("#user-settings-profile",{reverse:!1,changeHash:!1})})},set_back_button:function(t){e("#header-back-button").attr("href",t)},charactercosts:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t,["skills","disciplines","backgrounds"]).done(function(t){a.characterCostsView.model=t,a.characterCostsView.render(),e.mobile.changePage("#character-costs",{reverse:!1,changeHash:!1})})},characterlog:function(t,a,r){var i=this;e.mobile.loading("show"),i.set_back_button("#character?"+t),i.get_character(t,"all").done(function(t){i.characterLogView.register(t,a,r);e(".ui-page-active").attr("id"),e.mobile.changePage("#character-log",{reverse:!1,changeHash:!1});e.mobile.loading("hide")})},characterexperience:function(t,a,r){var i=this;e.mobile.loading("show"),i.set_back_button("#character?"+t),i.get_character(t,"all").done(function(t){i.characterExperienceView.register(t,a,r);e(".ui-page-active").attr("id"),e.mobile.changePage("#experience-notations-all",{reverse:!1,changeHash:!1});e.mobile.loading("hide")})},characterhistory:function(t,a){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t,"all").then(function(t){r.characterHistoryView.register(t,a).then(function(){e(".ui-page-active").attr("id"),e.mobile.changePage("#character-history",{reverse:!1,changeHash:!1});e.mobile.loading("hide")})}).fail(q)},characterapproval:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t,"all").then(function(t){a.characterApprovalView.register(t).then(function(){e(".ui-page-active").attr("id"),e.mobile.changePage("#character-approval",{reverse:!1,changeHash:!1});e.mobile.loading("hide")})}).fail(q)},characterrename:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t,"all").then(function(e){return a.characterRenameView=a.characterRenameView||new te({el:"#character-rename-main"}),a.characterRenameView.register(e)}).then(function(){e.mobile.changePage("#character-rename",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},characterprint:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t,"all").done(function(t){a.characterPrintView.setup(t),e.mobile.changePage("#printable-sheet",{reverse:!1,changeHash:!1})}).fail(q)},characternew:function(){var t=this;e.mobile.loading("show"),t.set_back_button("#characters?all"),t.characterNewView.render(),e.mobile.changePage("#character-new",{reverse:!1,changeHash:!1})},charactercreate:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t,[]).then(function(e){return e.fetch_all_creation_elements()}).done(function(t){a.characterCreateView.model=t,a.characterCreateView.render(),a.characterCreateView.scroll_back_after_page_change(),e.mobile.changePage("#character-create",{reverse:!1,changeHash:!1}),e.mobile.loading("hide")}).fail(q)},charactercreatepicksimpletrait:function(t,a,r){var i=this;r=_.parseInt(r),e.mobile.loading("show"),i.set_back_button("#charactercreate/"+a),i.get_character(a,[t]).done(function(a){var n;"disciplines"==t?n="in clan disciplines":"wta_gifts"==t&&(n=["affinity","show_only_value_1"]),i.characterCreateSimpleTraitNewView.register(a,t,r,"#charactercreate/<%= self.character.id %>",n,"#charactercreate/simpletraits/<%= self.category %>/<%= self.character.id %>/specialize/<%= b.linkId() %>/"+r),i.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.mobile.changePage("#character-create-simpletrait-new",{reverse:!1,changeHash:!1})})},charactercreatespecializesimpletrait:function(t,a,r,i){var n=this;i=_.parseInt(i),e.mobile.loading("show"),n.set_back_button("#charactercreate/"+a),n.get_character(a,[t]).then(function(e){return e.get_trait(t,r)}).then(function(e,a){return n.simpleTraitSpecializationView.register(a,e,t,window.location.hash,"#charactercreate/"+a.id)}).then(function(){e.mobile.changePage("#simpletrait-specialization",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},charactercreateunpicksimpletrait:function(t,a,r,i){var n=this;i=_.parseInt(i),e.mobile.loading("show"),n.set_back_button("#charactercreate/"+a),n.get_character(a,[t]).then(function(e){return n.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.unpick_from_creation(t,r,i)}).done(function(e){window.location.hash="#charactercreate/"+e.id}).fail(function(e){console.log(e.message)})},charactercreatepicksimpletext:function(t,a,r){var i=this;e.mobile.loading("show"),i.set_back_button("#charactercreate/"+r),i.get_character(r,[t]).done(function(r){i.simpleTextNewView.register(r,t,a,"#charactercreate/"+r.id),i.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.mobile.changePage("#simpletext-new",{reverse:!1,changeHash:!1})})},charactercreatecomplete:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#charactercreate/"+t),a.get_character(t).done(function(e){return e.complete_character_creation()}).then(function(){window.location.hash="#character?"+t}).fail(function(e){alert(e.message),window.location.hash="#charactercreate/"+t}).fail(q)},characterportrait:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t).done(function(e){return a.characterPortraitView.register(e)}).always(function(){e.mobile.changePage("#character-portrait",{reverse:!1,changeHash:!1})})},show_character_helper:function(t,a){e.mobile.loading("show"),this.set_back_button(a);var r=this.character;this.get_character(t).done(function(t){r.model=t,r.render(),r.scroll_back_after_page_change(),e.mobile.changePage("#character",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){window.location.hash=a})},character:function(e){this.show_character_helper(e,"#characters?all")},troupe_character:function(e,t){this.show_character_helper(t,"#troupe/"+e+"/characters/all")},administration_character:function(e){this.show_character_helper(e,"#administration/characters/all")},administration_users:function(){var t=this;e.mobile.loading("show"),t.enforce_logged_in().then(function(){t.set_back_button("#administration"),t.troupeAddStaffView=t.troupeAddStaffView||new j({el:"#troupe-add-staff"}),t.troupeAddStaffView.register("#administration/user/<%= id %>"),e.mobile.changePage("#troupe-add-staff",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},administration_user:function(a){var r=this;e.mobile.loading("show"),r.enforce_logged_in().then(function(){return r.set_back_button("#administration/users/all"),t.Promise.when(new t.Query("User").get(a),r.get_patronages(),$.get_users())}).then(function(t,i,n){var o=_.select(i.models,"attributes.owner.id",a);r.administrationUserView=r.administrationUserView||new O({patronages:i}),r.administrationUserView.register(t),r.administrationUserView.patronages.reset(o),e.mobile.changePage("#administration-user-view",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},administration_user_patronages:function(a){var r=this;e.mobile.loading("show"),r.enforce_logged_in().then(function(){return r.set_back_button("#administration/users/all"),new t.Query("User").get(a)}).then(function(t){r.administrationUserPatronagesView=r.administrationUserPatronagesView||new F({el:"#administration-user-patronages-view"}),r.administrationUserPatronagesView.register(t),e.mobile.changePage("#administration-user-patronages-view",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},administration_patronages:function(){var a=this;a.set_back_button("#administration"),e.mobile.loading("show"),a.enforce_logged_in().then(function(){return t.Promise.when(a.get_patronages(),$.get_users())}).then(function(t,r){_.has(a,"administrationPatronagesView")||(a.administrationPatronagesView=new K({el:"#administration-patronages-view-list",collection:t}),a.administrationPatronagesView.render()),e.mobile.changePage("#administration-patronages-view",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){e.mobile.loading("hide")})},administration_patronage:function(a){var r=this;r.set_back_button("#administration/patronages"),e.mobile.loading("show"),r.enforce_logged_in().then(function(){return t.Promise.when(r.get_patronage(a),$.get_users())}).then(function(t,a){r.administrationPatronageView&&r.administrationPatronageView.remove(),r.administrationPatronageView=new X({model:t}),r.administrationPatronageView.render(),e("#administration-patronage-view").find("div[role='main']").append(r.administrationPatronageView.el),e.mobile.changePage("#administration-patronage-view",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){e.mobile.loading("hide")})},administration_patronage_new:function(a){var r=this;r.set_back_button("#administration/patronages"),e.mobile.loading("show"),r.enforce_logged_in().then(function(){return t.Promise.when(new Z,$.get_users())}).then(function(t,i){r.administrationPatronageView&&r.administrationPatronageView.remove(),t.set("owner",i.get(a)),r.administrationPatronageView=new X({model:t}),r.administrationPatronageView.render(),e("#administration-patronage-view").find("div[role='main']").append(r.administrationPatronageView.el),e.mobile.changePage("#administration-patronage-view",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){e.mobile.loading("hide")})},administration_descriptions:function(){var t=this;t.set_back_button("#administration"),e.mobile.loading("show"),t.enforce_logged_in().then(function(){return t.administrationDescriptionsView=t.administrationDescriptionsView||(new ie).setup(),t.administrationDescriptionsView.update_categories()}).then(function(){e.mobile.changePage("#administration-descriptions",{reverse:!1,changeHash:!1})}).fail(function(){e.mobile.loading("hide")}).fail(q)},characterdelete:function(t){var a=this;e.mobile.loading("show"),this.set_back_button("#character?"+t),a.get_character(t).done(function(t){a.characterDeleteView.register(t,"#characters?all",function(){return a.characters.collection.fetch({reset:!0})}),e.mobile.changePage("#character-delete",{reverse:!1,changeHash:!1})})},get_user_characters:function(){var e=this,a=[];"devuser"==t.User.current().get("username")&&(a.sortbycreated=!0);var r=t.Promise.as([]),i=new t.Query(h);return i.equalTo("owner",t.User.current()),i.include("portrait"),r=i.each(function(e){a.push(e)}).then(function(){e.characters.collection.reset(a)}),r.done(function(){return t.Promise.as(e.characters.collection)})},get_troupe_characters:function(e,a){var r=this;a=_.defaults({},a,{includedeleted:!1});var i=[];"devuser"==t.User.current().get("username")&&(i.sortbycreated=!0);var n=t.Promise.as([]),o=new t.Query(h);return o.equalTo("troupes",e),o.include("portrait"),o.include("owner"),n=o.each(function(e){var t=!0;console.log(JSON.stringify(a)),a.includedeleted||e.has("owner")||(t=!1),t&&i.push(e)}).then(function(){r.troupeCharacters.collection.reset(i)}),n.done(function(){return t.Promise.as(r.troupeCharacters.collection)})},get_troupe_summarize_characters:function(a,r){var i=[];"devuser"==t.User.current().get("username")&&(i.sortbycreated=!0);var n=t.Promise.as([]),o=new t.Query(h);return o.equalTo("troupes",a),o.include("portrait"),o.include("owner"),_.each(h.all_simpletrait_categories(),function(e){o.include(e[0])}),e.mobile.loading("show",{text:"Fetching all characters",textVisible:!0}),n=o.each(function(e){i.push(e)}).then(function(){e.mobile.loading("show",{text:"Updating local character list",textVisible:!0}),r.reset(i)}),n.done(function(){return e.mobile.loading("show",{text:"Transitioning",textVisible:!0}),t.Promise.as(r)})},get_administrator_characters:function(){var e=this,a=[];"devuser"==t.User.current().get("username")&&(a.sortbycreated=!0);var r=t.Promise.as([]),i=new t.Query(h);return i.exists("owner"),i.include("portrait"),i.include("owner"),r=i.each(function(e){a.push(e)}).then(function(){e.characters.collection.reset(a)}),r.done(function(){return t.Promise.as(e.characters.collection)})},get_patronages:function(){var e=this,t=t||{};return _.defaults(t,{update:!0}),e.patronages=e.patronages||new G,e.patronages.fetch()},get_patronage:function(e){var a=this;if(!e)return t.Promise.as(new Z);if(_.has(a,"patronages")){var r=a.patronages.get(e);if(r)return t.Promise.as(r)}return new t.Query("Patronage").get(e)},characters:function(t){var a=this;"all"==t&&(a.set_back_button("#"),e.mobile.loading("show"),a.enforce_logged_in().then(function(){return a.get_user_characters()}).then(function(t){a.characters.register("#character?<%= character_id %>"),e.mobile.changePage("#characters-all",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){e.mobile.loading("hide")}))},enforce_logged_in:function(){var a=this;if(!t.User.current()){e.mobile.changePage("#login",{reverse:!1,changeHash:!1}),e.mobile.loading("hide");var r=new t.Error(t.Error.USERNAME_MISSING,"Not logged in");return t.Promise.error(r)}var i=t.User.current();e("#header-logout-button").attr("href","#logout"),e("#header-logout-button").text("Log Out "+i.get("username")),a.footerTemplate=_.template(J)(),e('div[data-role="footer"] > div[data-role="navbar"]').html(a.footerTemplate).trigger("create"),"undefined"!=typeof trackJs?trackJs.configure({userId:i.get("username"),sessionId:i.getSessionToken()}):console.log("Something is blocking trackJs. No user debugging available.");var n=new t.Query(t.Role).equalTo("users",t.User.current()).equalTo("name","Administrator"),o=new t.Query(t.Role).equalTo("users",t.User.current()).equalTo("name","SiteAdministrator"),c=t.Query.or(n,o);return c.count().then(function(e){var a=!!e,r=t.User.current();return r.get("admininterface")!=a?(r.set("admininterface",a),B(r),r.save()):t.Promise.as(t.User.current())})},get_character:function(e,t){var a=this;return a.enforce_logged_in().then(function(){return a._get_character(e,t)})},_check_character_mismatch:function(a){return a.get("owner").id!=t.User.current().id?a.check_server_client_permissions_mismatch().then(function(){return a.is_mismatched?(e.mobile.loading("show",{text:"Server data mismatch. Attempting to correct.",textVisible:!0}),a.update_troupe_acls()):t.Promise.as(a)}):t.Promise.as(a)},_get_character:function(e,a){var r=this,i=new t.Query("Vampire").select("type");return i.get(e).then(function(t){return"Werewolf"==t.get("type")?ne.get_character(e,a,r):h.get_character(e,a,r)}).then(r._check_character_mismatch)},simpletrait:function(t,a,r){var i=this;i.set_back_button("#simpletraits/"+t+"/"+a+"/all"),i.get_character(a,[t]).done(function(e){return character=e,character.get_trait(t,r)}).then(function(a,r){i.simpleTraitChangeView.register(r,a,t),e.mobile.changePage("#simpletrait-change",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},simpletraitspecialize:function(t,a,r){var i=this;i.set_back_button("#simpletraits/"+t+"/"+a+"/all"),i.get_character(a,[t]).done(function(e){return character=e,character.get_trait(t,r)}).then(function(e,a){return i.simpleTraitSpecializationView.register(a,e,t,"#simpletraits/<%= self.category %>/<%= self.character.id %>/all","#simpletraits/<%= self.category %>/<%= self.character.id %>/all")}).then(function(){e.mobile.changePage("#simpletrait-specialization",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},simpletraitnew:function(t,a,r,i,n){var o=this;o.set_back_button("#simpletraits/"+t+"/"+a+"/all"),o.get_character(a,[t]).then(function(a){var c=new d({name:r,value:_.parseInt(i),free_value:_.parseInt(n),category:t});o.simpleTraitChangeView.register(a,c,t),e.mobile.changePage("#simpletrait-change",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},simpletrait_new_specialize:function(t,a,r,i,n){var o=this;o.set_back_button("#simpletraits/"+t+"/"+a+"/all"),o.get_character(a,[t]).then(function(e){var c=new d({name:r,value:_.parseInt(i),free_value:_.parseInt(n)});return o.simpleTraitNewSpecializationView.register(c,t,"#simpletraits/<%= self.category %>/"+a+"/all","#simpletrait/spacer/<%= self.category %>/"+a+"/<%= b.get('name') %>/<%= b.get('value') %>/<%= b.get('free_value') %>/new")}).then(function(){e.mobile.changePage("#simpletrait-new-specialization",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},simpletextpick:function(t,a,r){var i=this;e.mobile.loading("show"),i.set_back_button("#character?"+r),i.get_character(r,[t]).done(function(r){i.simpleTextNewView.register(r,t,a,"#character?"+r.id),i.character.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.mobile.changePage("#simpletext-new",{reverse:!1,changeHash:!1})})},simpletraits:function(t,a,r){var i=this;"all"==r&&(e.mobile.loading("show"),i.set_back_button("#character?"+a),i.get_character(a,[t]).done(function(a){i.simpleTraitCategoryView.register(a,t),e.mobile.changePage("#simpletraitcategory-all",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})),"new"==r&&(e.mobile.loading("show"),i.set_back_button("#simpletraits/"+t+"/"+a+"/all"),i.get_character(a,[t]).done(function(a){i.simpleTraitNewView.register(a,t),e.mobile.changePage("#simpletrait-new",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)}))},victims:function(t){"all"==t&&e.mobile.changePage("#victims-all",{reverse:!1,changeHash:!1})},category:function(t){var a=this[t+"View"];a.collection.length?e.mobile.changePage("#"+t,{reverse:!1,changeHash:!1}):(e.mobile.loading("show"),a.collection.fetch().done(function(){e.mobile.changePage("#"+t,{reverse:!1,changeHash:!1})}))},character_list_troupes:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t).then(function(e){return a.characterListTroupesView=a.characterListTroupesView||new A({el:"#character-pick-troupe-to-show"}).render(),a.characterListTroupesView.register("#character/"+t+"/troupe/<%= troupe_id %>/show",function(t){t.containedIn("objectId",e.get_troupe_ids())})}).then(function(){e.mobile.changePage("#character-pick-troupe-to-show",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},character_pick_troupe_to_leave:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t).then(function(e){return a.characterPickTroupeToLeaveView=a.characterPickTroupeToLeaveView||new A({el:"#character-pick-troupe-to-leave"}).render(),a.characterPickTroupeToLeaveView.register("#character/"+t+"/troupe/<%= troupe_id %>/leave",function(t){t.containedIn("objectId",e.get_troupe_ids())})}).then(function(){e.mobile.changePage("#character-pick-troupe-to-leave",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},character_pick_troupe_to_join:function(t){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t).then(function(e){return a.characterPickTroupeToJoinView=a.characterPickTroupeToJoinView||new A({el:"#character-pick-troupe-to-join"}).render(),a.characterPickTroupeToJoinView.register("#character/"+t+"/troupe/<%= troupe_id %>/join",function(t){t.notContainedIn("objectId",e.get_troupe_ids())})}).then(function(){e.mobile.changePage("#character-pick-troupe-to-join",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},character_show_troupe:function(t,a){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t);var i,n;r.get_character(t).then(function(e){i=e;var t=new R({id:a});return t.fetch()}).then(function(t){n=t,r.troupeView=r.troupeView||new L({el:"#troupe"}),r.troupeView.register(n),e.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).fail(function(){window.location.hash="#character?"+t}).always(function(){e.mobile.loading("hide")}).fail(q)},character_join_troupe:function(t,a){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t);var i,n;r.get_character(t).then(function(e){i=e;var t=new R({id:a});return t.fetch()}).then(function(e){return n=e,i.join_troupe(e)}).then(function(){r.troupeView=r.troupeView||new L({el:"#troupe"}),r.troupeView.register(n),e.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).fail(function(){window.location.hash="#character?"+t}).always(function(){e.mobile.loading("hide")}).fail(q)},character_leave_troupe:function(t,a){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t);var i,n;r.get_character(t).then(function(e){i=e;var t=new R({id:a});return t.fetch()}).then(function(e){return n=e,i.leave_troupe(e)}).always(function(){window.location.hash="#character?"+t,e.mobile.loading("hide")}).fail(q)},troupecharacters:function(a,r){var i=this;e.mobile.loading("show"),i.enforce_logged_in().then(function(){i.set_back_button("#troupe/"+a);var e=new t.Query("Troupe").include("portrait").get(a);return e}).then(function(e,t){return i.get_troupe_characters(e)}).then(function(){i.troupeCharacters=i.troupeCharacters||new s({el:"#troupe-characters-all",collection:new l}),i.troupeCharacters.register("#troupe/"+a+"/character/<%= character_id %>"),e.mobile.changePage("#troupe-characters-all",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},troupesummarizecharacters:function(a,r){var i=this;e.mobile.loading("show"),i.enforce_logged_in().then(function(){i.set_back_button("#troupe/"+a);var e=new t.Query("Troupe").include("portrait").get(a);return e}).then(function(e,t){return i.troupeSummarizeCharacters=i.troupeSummarizeCharacters||new ee({collection:new l}).setup(),i.troupeCharacters.register("#troupe/"+a+"/character/<%= character_id %>"),i.get_troupe_summarize_characters(e,i.troupeSummarizeCharacters.collection)}).then(function(){e.mobile.changePage("#troupe-summarize-characters-all",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},troupe_portrait:function(a){var r=this;e.mobile.loading("show"),r.enforce_logged_in().then(function(){r.set_back_button("#troupe/"+a);var e=new t.Query("Troupe").include("portrait").get(a);return e}).then(function(t){r.troupePortraitView=r.troupePortraitView||new D({el:"#troupe-portrait"}),r.troupePortraitView.register(t),e.mobile.changePage("#troupe-portrait",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},troupe_relationship_network:function(a){var r=this;e.mobile.loading("show"),r.enforce_logged_in().then(function(){r.set_back_button("#troupe/"+a);var e=new t.Query("Troupe").include("portrait").get(a);return e}).then(function(e,t){return r.get_troupe_characters(e)}).then(function(e){return r.troupeCharacterRelationshipsNetworkView.register(e)}).always(function(){e.mobile.changePage("#troupe-character-relationships-network",{reverse:!1,changeHash:!1}),e.mobile.loading("hide")}).fail(q)},troupeeditstaff:function(a,r){var i=this;e.mobile.loading("show"),i.enforce_logged_in().then(function(){i.set_back_button("#troupe/"+a);var e=new t.Query("Troupe").include("portrait").get(a),n=new t.Query("User").get(r);return t.Promise.when(e,n)}).then(function(e,t){return i.troupeEditStaffView=i.troupeEditStaffView||new E({el:"#troupe-edit-staff"}),i.troupeEditStaffView.register(e,t)}).then(function(){e.mobile.changePage("#troupe-edit-staff",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(function(e){_.isArray(e)?_.each(e,function(e){console.log("Something failed"+e.message)}):console.log("error updating experience"+e.message)})},troupeaddstaff:function(a){var r=this;e.mobile.loading("show"),r.enforce_logged_in().then(function(){return r.set_back_button("#troupe/"+a),new t.Query("Troupe").get(a)}).then(function(t){r.troupeAddStaffView=r.troupeAddStaffView||new j({el:"#troupe-add-staff"}),r.troupeAddStaffView.register("#troupe/"+t.id+"/staff/edit/<%= id %>"),e.mobile.changePage("#troupe-add-staff",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},troupe:function(a){var r=this;e.mobile.loading("show"),r.enforce_logged_in().then(function(){return r.set_back_button("#troupes"),new t.Query("Troupe").get(a)}).then(function(a){r.troupeView=r.troupeView||new L({el:"#troupe"});var i=t.User.current().get("storytellerinterface"),n=t.User.current().get("admininterface");r.troupeView.register(a,!(i||n)),e.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide");
})},troupes:function(){var t=this;e.mobile.loading("show"),t.enforce_logged_in().then(function(){return t.set_back_button("#"),t.troupesListView=t.troupesListView||new A({el:"#troupes-list"}).render(),t.troupesListView.register()}).then(function(){e.mobile.changePage("#troupes-list",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},troupenew:function(){var t=this;e.mobile.loading("show"),t.enforce_logged_in().then(function(){t.set_back_button("#troupes"),t.troupeNewView=t.troupeNewView||new I({el:"#troupe-new"}).render(),e.mobile.changePage("#troupe-new",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},administration:function(){var t=this;t.enforce_logged_in().then(function(){t.set_back_button("#"),e.mobile.changePage("#administration",{reverse:!1,changeHash:!1})})},administration_characters_all:function(){var t=this;e.mobile.loading("show"),t.enforce_logged_in().then(function(){return t.set_back_button("#administration"),t.get_administrator_characters()}).then(function(){t.characters.register("#administration/character/<%= character_id %>"),e.mobile.changePage("#characters-all",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)}});return oe});