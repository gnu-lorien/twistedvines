define(["jquery","parse","pretty","jscookie","moment","../models/CategoryModel","../collections/CategoriesCollection","../views/CategoryView","../views/CharactersListView","../models/Vampire","../collections/Vampires","../views/CharacterView","../views/SimpleTraitCategoryView","../views/SimpleTraitNewView","../models/SimpleTrait","../views/SimpleTraitChangeView","../models/VampireCreation","../views/CharacterCreateView","../views/CharacterNewView","../views/CharacterPrintView","../views/CharacterCostsView","../views/SimpleTextNewView","../views/SimpleTraitSpecializationView","../views/CharacterLogView","../views/CharacterHistoryView","../views/SignupView","../views/LoginView","../views/CharacterExperienceView","../views/UserSettingsProfileView","../views/CharacterPortraitView","../views/TroupeCharacterRelationshipsNetworkView","../views/CharacterDeleteView","../views/PlayerOptionsView","../views/TroupeNewView","../views/TroupesListView","../views/TroupeView","../views/UsersView","../views/TroupeEditStaffView","../models/Troupe","../helpers/PromiseFailReport","../views/TroupePortraitView","text!../templates/footer.html","../views/AdministrationUserView","../views/PasswordReset","../views/CharacterApprovalView","../helpers/InjectAuthData","../views/AdministrationUserView","../collections/Patronages","../views/PatronagesView","../views/PatronageView","../collections/Users","../models/Patronage","../helpers/UserWreqr"],function(e,t,r,a,i,n,o,c,s,h,l,u,g,d,p,w,m,f,b,v,V,P,k,y,T,H,C,U,S,x,N,A,Q,j,L,z,E,I,R,q,O,J,D,M,B,F,G,W,K,X,Y,Z,$){var ee=t.Router.extend({initialize:function(){this._character=null,_.bindAll(this,"get_character"),this.animalsView=new c({el:"#animals",collection:new o([],{type:"animals"})}),this.colorsView=new c({el:"#colors",collection:new o([],{type:"colors"})}),this.vehiclesView=new c({el:"#vehicles",collection:new o([],{type:"vehicles"})}),this.characters=new s({el:"#characters-all",collection:new l}),this.troupeCharacters=new s({el:"#troupe-characters-all",collection:new l}),this.character=new u({el:"#character"}),this.simpleTraitCategoryView=new g({el:"#simpletraitcategory-all"}),this.simpleTraitNewView=new d({el:"#simpletrait-new"}),this.simpleTraitChangeView=new w({el:"#simpletrait-change"}),this.simpleTextNewView=new P({el:"#simpletext-new"}),this.simpleTraitSpecializationView=new k({el:"#simpletrait-specialization"}),this.characterCreateView=new f({el:"#character-create"}),this.characterNewView=new b({el:"#character-new"}),this.characterPrintView=new v({el:"#printable-sheet"}),this.characterCostsView=new V({el:"#character-costs"}),this.characterLogView=new y({el:"#character-log"}),this.characterHistoryView=new T({el:"#character-history"}),this.characterExperienceView=new U({el:"#experience-notations-all"}),this.characterPortraitView=new x({el:"#character-portrait"}),this.characterDeleteView=new A({el:"#character-delete"}),this.characterApprovalView=new B({el:"#character-approval"}),this.loginView=new C,this.signupView=new H,this.troupeCharacterRelationshipsNetworkView=new N({el:"#troupe-character-relationships-network"}),t.history.start()},routes:{"":"home",start:"home",logout:"logout",signup:"signup",reset:"resetpassword",profile:"profile","category?:type":"category","victims?:type":"victims","characters?:type":"characters","character?:id":"character","simpletraits/:category/:cid/:type":"simpletraits","simpletrait/:category/:cid/:bid":"simpletrait","simpletrait/specialize/:category/:cid/:bid":"simpletraitspecialize","simpletext/:category/:target/:cid/pick":"simpletextpick","charactercreate/:cid":"charactercreate","charactercreate/simpletraits/:category/:cid/pick/:i":"charactercreatepicksimpletrait","charactercreate/simpletraits/:category/:cid/unpick/:stid/:i":"charactercreateunpicksimpletrait","charactercreate/simpletraits/:category/:cid/specialize/:stid/:i":"charactercreatespecializesimpletrait","charactercreate/simpletext/:category/:target/:cid/pick":"charactercreatepicksimpletext","charactercreate/complete/:cid":"charactercreatecomplete",characternew:"characternew","character/:cid/print":"characterprint","character/:cid/costs":"charactercosts","character/:cid/log/:start/:changeBy":"characterlog","character/:cid/history/:id":"characterhistory","character/:cid/portrait":"characterportrait","character/:cid/delete":"characterdelete","character/:cid/troupes":"character_list_troupes","character/:cid/troupes/leave":"character_pick_troupe_to_leave","character/:cid/troupes/join":"character_pick_troupe_to_join","character/:cid/troupe/:tid/join":"character_join_troupe","character/:cid/troupe/:tid/leave":"character_leave_troupe","character/:cid/troupe/:tid/show":"character_show_troupe","character/:cid/approval":"characterapproval","character/:cid/experience/:start/:changeBy":"characterexperience","troupe/new":"troupenew",troupes:"troupes","troupe/:id":"troupe","troupe/:id/staff/add":"troupeaddstaff","troupe/:id/staff/edit/:uid":"troupeeditstaff","troupe/:id/characters/:type":"troupecharacters","troupe/:id/characters/relationships/network":"troupe_relationship_network","troupe/:id/character/:cid":"troupe_character","troupe/:id/portrait":"troupe_portrait",administration:"administration","administration/characters/all":"administration_characters_all","administration/character/:id":"administration_character","administration/users/all":"administration_users","administration/user/:id":"administration_user","administration/patronages/user/:id":"administration_user_patronages","administration/patronages":"administration_patronages","administration/patronage/:id":"administration_patronage","administration/patronages/new":"administration_patronage_new","administration/patronages/new/:userid":"administration_patronage_new"},home:function(){var r=this;this.enforce_logged_in().then(function(){var e=new t.Query(t.Role).equalTo("users",t.User.current());return e.count()}).then(function(e){var r=t.User.current();return 0<e?r.set("storytellerinterface",!0):r.set("storytellerinterface",!1),F(r),r.save()}).then(function(){r.playerOptionsView=r.playerOptionsView||new Q({el:"#player-options"}).render(),e.mobile.changePage("#player-options",{reverse:!1,changeHash:!1})}).fail(q)},logout:function(){t.User.logOut().always(function(){return hello("facebook").logout()}).always(function(){window.location.hash="",window.location.reload()})},signup:function(){t.User.current()?window.location.hash="":e.mobile.changePage("#signup",{reverse:!1,changeHash:!1})},resetpassword:function(){var t=this;t.resetPasswordView=t.resetPasswordView||new M({el:"#user-reset-password"}),t.resetPasswordView.render(),e.mobile.changePage("#user-reset-password",{reverse:!1,changeHash:!1})},profile:function(){var t=this;t.enforce_logged_in().then(function(){return $.get_users()}).then(function(){t.set_back_button("#"),t.userSettingsProfileView=t.userSettingsProfileView||(new S).setup(),e.mobile.changePage("#user-settings-profile",{reverse:!1,changeHash:!1})})},set_back_button:function(t){e("#header-back-button").attr("href",t)},charactercosts:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t,["skills","disciplines","backgrounds"]).done(function(t){r.characterCostsView.model=t,r.characterCostsView.render(),e.mobile.changePage("#character-costs",{reverse:!1,changeHash:!1})})},characterlog:function(t,r,a){var i=this;e.mobile.loading("show"),i.set_back_button("#character?"+t),i.get_character(t,"all").done(function(t){i.characterLogView.register(t,r,a);e(".ui-page-active").attr("id"),e.mobile.changePage("#character-log",{reverse:!1,changeHash:!1});e.mobile.loading("hide")})},characterexperience:function(t,r,a){var i=this;e.mobile.loading("show"),i.set_back_button("#character?"+t),i.get_character(t,"all").done(function(t){i.characterExperienceView.register(t,r,a);e(".ui-page-active").attr("id"),e.mobile.changePage("#experience-notations-all",{reverse:!1,changeHash:!1});e.mobile.loading("hide")})},characterhistory:function(t,r){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t),a.get_character(t,"all").then(function(t){a.characterHistoryView.register(t,r).then(function(){e(".ui-page-active").attr("id"),e.mobile.changePage("#character-history",{reverse:!1,changeHash:!1});e.mobile.loading("hide")})}).fail(q)},characterapproval:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t,"all").then(function(t){r.characterApprovalView.register(t).then(function(){e(".ui-page-active").attr("id"),e.mobile.changePage("#character-approval",{reverse:!1,changeHash:!1});e.mobile.loading("hide")})}).fail(q)},characterprint:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t,"all").done(function(t){r.characterPrintView.character=t,r.characterPrintView.render(),e.mobile.changePage("#printable-sheet",{reverse:!1,changeHash:!1})}).fail(q)},characternew:function(){var t=this;e.mobile.loading("show"),t.set_back_button("#characters?all"),t.characterNewView.model=new h,t.characterNewView.render(),e.mobile.changePage("#character-new",{reverse:!1,changeHash:!1})},charactercreate:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t,[]).then(function(e){return e.fetch_all_creation_elements()}).done(function(t){r.characterCreateView.model=t,r.characterCreateView.render(),r.characterCreateView.scroll_back_after_page_change(),e.mobile.changePage("#character-create",{reverse:!1,changeHash:!1}),e.mobile.loading("hide")}).fail(q)},charactercreatepicksimpletrait:function(t,r,a){var i=this;a=_.parseInt(a),e.mobile.loading("show"),i.set_back_button("#charactercreate/"+r),i.get_character(r,[t]).done(function(r){var n;"disciplines"==t&&(n="in clan disciplines"),i.simpleTraitNewView.register(r,t,a,"#charactercreate/<%= self.character.id %>",n,"#charactercreate/simpletraits/<%= self.category %>/<%= self.character.id %>/specialize/<%= b.linkId() %>/"+a),i.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.mobile.changePage("#simpletrait-new",{reverse:!1,changeHash:!1})})},charactercreatespecializesimpletrait:function(t,r,a,i){var n=this;i=_.parseInt(i),e.mobile.loading("show"),n.set_back_button("#charactercreate/"+r),n.get_character(r,[t]).then(function(e){return e.get_trait(t,a)}).then(function(r,a){n.simpleTraitSpecializationView.register(a,r,t,window.location.hash,"#charactercreate/"+a.id),e.mobile.changePage("#simpletrait-specialization",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},charactercreateunpicksimpletrait:function(t,r,a,i){var n=this;i=_.parseInt(i),e.mobile.loading("show"),n.set_back_button("#charactercreate/"+r),n.get_character(r,[t]).then(function(e){return n.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.unpick_from_creation(t,a,i)}).done(function(e){window.location.hash="#charactercreate/"+e.id}).fail(function(e){console.log(e.message)})},charactercreatepicksimpletext:function(t,r,a){var i=this;e.mobile.loading("show"),i.set_back_button("#charactercreate/"+a),i.get_character(a,[t]).done(function(a){i.simpleTextNewView.register(a,t,r,"#charactercreate/"+a.id),i.characterCreateView.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.mobile.changePage("#simpletext-new",{reverse:!1,changeHash:!1})})},charactercreatecomplete:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#charactercreate/"+t),r.get_character(t).done(function(e){return e.complete_character_creation()}).then(function(){window.location.hash="#character?"+t}).fail(function(e){alert(e.message),window.location.hash="#charactercreate/"+t}).fail(q)},characterportrait:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t).done(function(e){return r.characterPortraitView.register(e)}).always(function(){e.mobile.changePage("#character-portrait",{reverse:!1,changeHash:!1})})},show_character_helper:function(t,r){e.mobile.loading("show"),this.set_back_button(r);var a=this.character;this.get_character(t).done(function(t){a.model=t,a.render(),a.scroll_back_after_page_change(),e.mobile.changePage("#character",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){window.location.hash=r})},character:function(e){this.show_character_helper(e,"#characters?all")},troupe_character:function(e,t){this.show_character_helper(t,"#troupe/"+e+"/characters/all")},administration_character:function(e){this.show_character_helper(e,"#administration/characters/all")},administration_users:function(){var t=this;e.mobile.loading("show"),t.enforce_logged_in().then(function(){t.set_back_button("#administration"),t.troupeAddStaffView=t.troupeAddStaffView||new E({el:"#troupe-add-staff"}),t.troupeAddStaffView.register("#administration/user/<%= id %>"),e.mobile.changePage("#troupe-add-staff",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},administration_user:function(r){var a=this;e.mobile.loading("show"),a.enforce_logged_in().then(function(){return a.set_back_button("#administration/users/all"),t.Promise.when(new t.Query("User").get(r),a.get_patronages(),$.get_users())}).then(function(t,i,n){var o=_.select(i.models,"attributes.owner.id",r);a.administrationUserView=a.administrationUserView||new D({patronages:i}),a.administrationUserView.register(t),a.administrationUserView.patronages.reset(o),e.mobile.changePage("#administration-user-view",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},administration_user_patronages:function(r){var a=this;e.mobile.loading("show"),a.enforce_logged_in().then(function(){return a.set_back_button("#administration/users/all"),new t.Query("User").get(r)}).then(function(t){a.administrationUserPatronagesView=a.administrationUserPatronagesView||new G({el:"#administration-user-patronages-view"}),a.administrationUserPatronagesView.register(t),e.mobile.changePage("#administration-user-patronages-view",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},administration_patronages:function(){var r=this;r.set_back_button("#administration"),e.mobile.loading("show"),r.enforce_logged_in().then(function(){return t.Promise.when(r.get_patronages(),$.get_users())}).then(function(t,a){_.has(r,"administrationPatronagesView")||(r.administrationPatronagesView=new K({el:"#administration-patronages-view-list",collection:t}),r.administrationPatronagesView.render()),e.mobile.changePage("#administration-patronages-view",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){e.mobile.loading("hide")})},administration_patronage:function(r){var a=this;a.set_back_button("#administration/patronages"),e.mobile.loading("show"),a.enforce_logged_in().then(function(){return t.Promise.when(a.get_patronage(r),$.get_users())}).then(function(t,r){a.administrationPatronageView&&a.administrationPatronageView.remove(),a.administrationPatronageView=new X({model:t}),a.administrationPatronageView.render(),e("#administration-patronage-view").find("div[role='main']").append(a.administrationPatronageView.el),e.mobile.changePage("#administration-patronage-view",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){e.mobile.loading("hide")})},administration_patronage_new:function(r){var a=this;a.set_back_button("#administration/patronages"),e.mobile.loading("show"),a.enforce_logged_in().then(function(){return t.Promise.when(new Z,$.get_users())}).then(function(t,i){a.administrationPatronageView&&a.administrationPatronageView.remove(),t.set("owner",i.get(r)),a.administrationPatronageView=new X({model:t}),a.administrationPatronageView.render(),e("#administration-patronage-view").find("div[role='main']").append(a.administrationPatronageView.el),e.mobile.changePage("#administration-patronage-view",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){e.mobile.loading("hide")})},characterdelete:function(t){var r=this;e.mobile.loading("show"),this.set_back_button("#character?"+t),r.get_character(t).done(function(t){r.characterDeleteView.register(t,"#characters?all",function(){return r.characters.collection.fetch({reset:!0})}),e.mobile.changePage("#character-delete",{reverse:!1,changeHash:!1})})},get_user_characters:function(){var e=this,r=[];"devuser"==t.User.current().get("username")&&(r.sortbycreated=!0);var a=t.Promise.as([]),i=new t.Query(h);return i.equalTo("owner",t.User.current()),i.include("portrait"),a=i.each(function(e){r.push(e)}).then(function(){e.characters.collection.reset(r)}),a.done(function(){return t.Promise.as(e.characters.collection)})},get_troupe_characters:function(e,r){var a=this;r=_.defaults({},r,{includedeleted:!1});var i=[];"devuser"==t.User.current().get("username")&&(i.sortbycreated=!0);var n=t.Promise.as([]),o=new t.Query(h);return o.equalTo("troupes",e),o.include("portrait"),o.include("owner"),n=o.each(function(e){var t=!0;console.log(JSON.stringify(r)),r.includedeleted||e.has("owner")||(t=!1),t&&i.push(e)}).then(function(){a.troupeCharacters.collection.reset(i)}),n.done(function(){return t.Promise.as(a.troupeCharacters.collection)})},get_administrator_characters:function(){var e=this,r=[];"devuser"==t.User.current().get("username")&&(r.sortbycreated=!0);var a=t.Promise.as([]),i=new t.Query(h);return i.exists("owner"),i.include("portrait"),i.include("owner"),a=i.each(function(e){r.push(e)}).then(function(){e.characters.collection.reset(r)}),a.done(function(){return t.Promise.as(e.characters.collection)})},get_patronages:function(){var e=this,t=t||{};return _.defaults(t,{update:!0}),e.patronages=e.patronages||new W,e.patronages.fetch()},get_patronage:function(e){var r=this;if(!e)return t.Promise.as(new Z);if(_.has(r,"patronages")){var a=r.patronages.get(e);if(a)return t.Promise.as(a)}return new t.Query("Patronage").get(e)},characters:function(t){var r=this;"all"==t&&(r.set_back_button("#"),e.mobile.loading("show"),r.enforce_logged_in().then(function(){return r.get_user_characters()}).then(function(t){r.characters.register("#character?<%= character_id %>"),e.mobile.changePage("#characters-all",{reverse:!1,changeHash:!1})}).fail(q).fail(function(){e.mobile.loading("hide")}))},enforce_logged_in:function(){var r=this;if(!t.User.current()){e.mobile.changePage("#login",{reverse:!1,changeHash:!1}),e.mobile.loading("hide");var a=new t.Error(t.Error.USERNAME_MISSING,"Not logged in");return t.Promise.error(a)}var i=t.User.current();e("#header-logout-button").attr("href","#logout"),e("#header-logout-button").text("Log Out "+i.get("username")),r.footerTemplate=_.template(J)(),e('div[data-role="footer"] > div[data-role="navbar"]').html(r.footerTemplate).trigger("create"),trackJs.configure({userId:i.get("username"),sessionId:i.getSessionToken()});var n=new t.Query(t.Role).equalTo("users",t.User.current()).equalTo("name","Administrator"),o=new t.Query(t.Role).equalTo("users",t.User.current()).equalTo("name","SiteAdministrator"),c=t.Query.or(n,o);return c.count().then(function(e){var r=!!e,a=t.User.current();return a.get("admininterface")!=r?(a.set("admininterface",r),F(a),a.save()):t.Promise.as(t.User.current())})},get_character:function(e,t){var r=this;return r.enforce_logged_in().then(function(){return r._get_character(e,t)})},_check_character_mismatch:function(r){return r.get("owner").id!=t.User.current().id?r.check_server_client_permissions_mismatch().then(function(){return r.is_mismatched?(e.mobile.loading("show",{text:"Server data mismatch. Attempting to correct.",textVisible:!0}),r.update_troupe_acls()):t.Promise.as(r)}):t.Promise.as(r)},_get_character:function(e,t){var r=this;return h.get_character(e,t,r).then(r._check_character_mismatch)},simpletrait:function(t,r,a){var i=this;i.set_back_button("#simpletraits/"+t+"/"+r+"/all"),i.get_character(r,[t]).done(function(e){return character=e,character.get_trait(t,a)}).then(function(r,a){i.simpleTraitChangeView.register(a,r,t),e.mobile.changePage("#simpletrait-change",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},simpletraitspecialize:function(t,r,a){var i=this;i.set_back_button("#simpletraits/"+t+"/"+r+"/all"),i.get_character(r,[t]).done(function(e){return character=e,character.get_trait(t,a)}).then(function(r,a){i.simpleTraitSpecializationView.register(a,r,t),e.mobile.changePage("#simpletrait-specialization",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})},simpletextpick:function(t,r,a){var i=this;e.mobile.loading("show"),i.set_back_button("#character?"+a),i.get_character(a,[t]).done(function(a){i.simpleTextNewView.register(a,t,r,"#character?"+a.id),i.character.backToTop=document.documentElement.scrollTop||document.body.scrollTop,e.mobile.changePage("#simpletext-new",{reverse:!1,changeHash:!1})})},simpletraits:function(t,r,a){var i=this;"all"==a&&(e.mobile.loading("show"),i.set_back_button("#character?"+r),i.get_character(r,[t]).done(function(r){i.simpleTraitCategoryView.register(r,t),e.mobile.changePage("#simpletraitcategory-all",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)})),"new"==a&&(e.mobile.loading("show"),i.set_back_button("#simpletraits/"+t+"/"+r+"/all"),i.get_character(r,[t]).done(function(r){i.simpleTraitNewView.register(r,t),e.mobile.changePage("#simpletrait-new",{reverse:!1,changeHash:!1})}).fail(function(e){console.log(e.message)}))},victims:function(t){"all"==t&&e.mobile.changePage("#victims-all",{reverse:!1,changeHash:!1})},category:function(t){var r=this[t+"View"];r.collection.length?e.mobile.changePage("#"+t,{reverse:!1,changeHash:!1}):(e.mobile.loading("show"),r.collection.fetch().done(function(){e.mobile.changePage("#"+t,{reverse:!1,changeHash:!1})}))},character_list_troupes:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t).then(function(e){return r.characterListTroupesView=r.characterListTroupesView||new L({el:"#character-pick-troupe-to-show"}).render(),r.characterListTroupesView.register("#character/"+t+"/troupe/<%= troupe_id %>/show",function(t){t.containedIn("objectId",e.get_troupe_ids())})}).then(function(){e.mobile.changePage("#character-pick-troupe-to-show",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},character_pick_troupe_to_leave:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t).then(function(e){return r.characterPickTroupeToLeaveView=r.characterPickTroupeToLeaveView||new L({el:"#character-pick-troupe-to-leave"}).render(),r.characterPickTroupeToLeaveView.register("#character/"+t+"/troupe/<%= troupe_id %>/leave",function(t){t.containedIn("objectId",e.get_troupe_ids())})}).then(function(){e.mobile.changePage("#character-pick-troupe-to-leave",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},character_pick_troupe_to_join:function(t){var r=this;e.mobile.loading("show"),r.set_back_button("#character?"+t),r.get_character(t).then(function(e){return r.characterPickTroupeToJoinView=r.characterPickTroupeToJoinView||new L({el:"#character-pick-troupe-to-join"}).render(),r.characterPickTroupeToJoinView.register("#character/"+t+"/troupe/<%= troupe_id %>/join",function(t){t.notContainedIn("objectId",e.get_troupe_ids())})}).then(function(){e.mobile.changePage("#character-pick-troupe-to-join",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},character_show_troupe:function(t,r){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t);var i,n;a.get_character(t).then(function(e){i=e;var t=new R({id:r});return t.fetch()}).then(function(t){n=t,a.troupeView=a.troupeView||new z({el:"#troupe"}),a.troupeView.register(n),e.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).fail(function(){window.location.hash="#character?"+t}).always(function(){e.mobile.loading("hide")}).fail(q)},character_join_troupe:function(t,r){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t);var i,n;a.get_character(t).then(function(e){i=e;var t=new R({id:r});return t.fetch()}).then(function(e){return n=e,i.join_troupe(e)}).then(function(){a.troupeView=a.troupeView||new z({el:"#troupe"}),a.troupeView.register(n),e.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).fail(function(){window.location.hash="#character?"+t}).always(function(){e.mobile.loading("hide")}).fail(q)},character_leave_troupe:function(t,r){var a=this;e.mobile.loading("show"),a.set_back_button("#character?"+t);var i,n;a.get_character(t).then(function(e){i=e;var t=new R({id:r});return t.fetch()}).then(function(e){return n=e,i.leave_troupe(e)}).always(function(){window.location.hash="#character?"+t,e.mobile.loading("hide")}).fail(q)},troupecharacters:function(r,a){var i=this;e.mobile.loading("show"),i.enforce_logged_in().then(function(){i.set_back_button("#troupe/"+r);var e=new t.Query("Troupe").include("portrait").get(r);return e}).then(function(e,t){return i.get_troupe_characters(e)}).then(function(){i.troupeCharacters=i.troupeCharacters||new s({el:"#troupe-characters-all",collection:new l}),i.troupeCharacters.register("#troupe/"+r+"/character/<%= character_id %>"),e.mobile.changePage("#troupe-characters-all",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},troupe_portrait:function(r){var a=this;e.mobile.loading("show"),a.enforce_logged_in().then(function(){a.set_back_button("#troupe/"+r);var e=new t.Query("Troupe").include("portrait").get(r);return e}).then(function(t){a.troupePortraitView=a.troupePortraitView||new O({el:"#troupe-portrait"}),a.troupePortraitView.register(t),e.mobile.changePage("#troupe-portrait",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)},troupe_relationship_network:function(r){var a=this;e.mobile.loading("show"),a.enforce_logged_in().then(function(){a.set_back_button("#troupe/"+r);var e=new t.Query("Troupe").include("portrait").get(r);return e}).then(function(e,t){return a.get_troupe_characters(e)}).then(function(e){return a.troupeCharacterRelationshipsNetworkView.register(e)}).always(function(){e.mobile.changePage("#troupe-character-relationships-network",{reverse:!1,changeHash:!1}),e.mobile.loading("hide")}).fail(q)},troupeeditstaff:function(r,a){var i=this;e.mobile.loading("show"),i.enforce_logged_in().then(function(){i.set_back_button("#troupe/"+r);var e=new t.Query("Troupe").include("portrait").get(r),n=new t.Query("User").get(a);return t.Promise.when(e,n)}).then(function(e,t){return i.troupeEditStaffView=i.troupeEditStaffView||new I({el:"#troupe-edit-staff"}),i.troupeEditStaffView.register(e,t)}).then(function(){e.mobile.changePage("#troupe-edit-staff",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(function(e){_.isArray(e)?_.each(e,function(e){console.log("Something failed"+e.message)}):console.log("error updating experience"+e.message)})},troupeaddstaff:function(r){var a=this;e.mobile.loading("show"),a.enforce_logged_in().then(function(){return a.set_back_button("#troupe/"+r),new t.Query("Troupe").get(r)}).then(function(t){a.troupeAddStaffView=a.troupeAddStaffView||new E({el:"#troupe-add-staff"}),a.troupeAddStaffView.register("#troupe/"+t.id+"/staff/edit/<%= id %>"),e.mobile.changePage("#troupe-add-staff",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},troupe:function(r){var a=this;e.mobile.loading("show"),a.enforce_logged_in().then(function(){return a.set_back_button("#troupes"),new t.Query("Troupe").get(r)}).then(function(r){a.troupeView=a.troupeView||new z({el:"#troupe"});var i=t.User.current().get("storytellerinterface"),n=t.User.current().get("admininterface");a.troupeView.register(r,!(i||n)),e.mobile.changePage("#troupe",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},troupes:function(){var t=this;e.mobile.loading("show"),t.enforce_logged_in().then(function(){return t.set_back_button("#administration"),t.troupesListView=t.troupesListView||new L({el:"#troupes-list"}).render(),t.troupesListView.register()}).then(function(){e.mobile.changePage("#troupes-list",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},troupenew:function(){var t=this;e.mobile.loading("show"),t.enforce_logged_in().then(function(){t.set_back_button("#troupes"),t.troupeNewView=t.troupeNewView||new j({el:"#troupe-new"}).render(),e.mobile.changePage("#troupe-new",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")})},administration:function(){var t=this;t.enforce_logged_in().then(function(){t.set_back_button("#"),e.mobile.changePage("#administration",{reverse:!1,changeHash:!1})})},administration_characters_all:function(){var t=this;e.mobile.loading("show"),t.enforce_logged_in().then(function(){return t.set_back_button("#administration"),t.get_administrator_characters()}).then(function(){t.characters.register("#administration/character/<%= character_id %>"),e.mobile.changePage("#characters-all",{reverse:!1,changeHash:!1})}).always(function(){e.mobile.loading("hide")}).fail(q)}});return ee});