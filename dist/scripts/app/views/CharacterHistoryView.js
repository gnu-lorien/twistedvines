define(["jquery","backbone","moment","text!../templates/character-print-view.html","text!../templates/character-history-selected-view.html","text!../templates/character-history-view.html","../helpers/VampirePrintHelper"],function(e,t,r,i,a,s,n){var c=t.View.extend({initialize:function(){var e=this;_.bindAll(this,"render","format_simpletext","format_attribute_value","format_attribute_focus","format_skill","format_specializations"),e.sheetTemplate=_.template(i),e.selectedTemplate=_.template(a)},register:function(e,t){var r=this,i=Parse.Promise.as([]);return e!==r.character&&(r.character&&(r.stopListening(r.character),r.character.recorded_changes&&r.stopListening(r.character.recorded_changes)),r.character=e,i=r.character.get_recorded_changes(function(e){r.listenTo(e,"add",r.render),r.listenTo(e,"reset",r.render),r.character.recorded_changes.length>0&&_.defer(r.render)})),i.then(function(){Parse.Promise.as(r)})},events:{change:"update_selected"},format_entry:function(e,t){if(_.isUndefined(e))return console.log("Undefined log"),"Undefined log";if(e.get(t))return e.get(t);var i=e[t];return _.isDate(i)?r(i).format("lll"):i},update_selected:function(e){var t=this,r=_.parseInt(this.$(e.target).val());t.idForPickedIndex=r,t._render_viewing(!0);var i=this.$("#history-changes-"+r).val(),a=_.chain(t.character.recorded_changes.models).takeRightWhile(function(e){return e.id!=i}).reverse().value(),s=t.character.get_transformed(a);t._render_sheet(s,!0)},_render_viewing:function(e){var t=this,r=t.idForPickedIndex;_.isUndefined(r)&&(r=t.character.recorded_changes.models.length-1),this.$el.find("#history-viewing").html(this.selectedTemplate({character:this.character,logs:t.character.recorded_changes.models,format_entry:this.format_entry,idForPickedIndex:r})),e&&this.$el.find("#history-viewing").enhanceWithin()},_render_sheet:function(e,t){var r=this;r.character_override=e||r.character;var i=r.character_override,a=i.get_sorted_skills(),s=i.get_grouped_skills(a,3);this.$el.find("#history-sheet").html(this.sheetTemplate({character:i,skills:a,groupedSkills:s,format_simpletext:this.format_simpletext,format_attribute_value:this.format_attribute_value,format_attribute_focus:this.format_attribute_focus,format_skill:this.format_skill,format_specializations:this.format_specializations})),t&&this.$el.find("#history-sheet").enhanceWithin()},render:function(){var e=this,t=e.idForPickedIndex;return _.isUndefined(t)&&(t=e.character.recorded_changes.models.length-1),this.template=_.template(s)({character:this.character,logs:this.character.recorded_changes.models,format_entry:this.format_entry,idForPickedIndex:t}),this.$el.find("#history-main").html(this.template),this._render_viewing(),this._render_sheet(),this.$el.enhanceWithin(),this}});return _.extend(c.prototype,n),c});