define(["underscore","jquery","backbone","text!../templates/character-summarize-list-item.html","marionette","../models/Vampire","backform","text!../templates/character-summarize-list-item-csv.html","text!../templates/character-summarize-list-item-csv-header-grouped.html"],function(e,t,a,i,l,n,r,o,s){var c=l.ItemView.extend({tagName:"li",className:"ul-li-has-thumb",template:e.template(i),initialize:function(e){this.mode=e.mode,this.name=e.name},templateHelpers:function(){var e=this;return{e:e.model,mode:e.mode,name:e.name}},events:{click:"clicked"},clicked:function(a){var i=this;a.preventDefault(),t.mobile.loading("show");var l=t(a.currentTarget),n=l.attr("backendId"),r=e.template(i.click_url)({character_id:n});window.location.hash=r},onRender:function(){this.$el.enhanceWithin()}}),m=l.ItemView.extend({tagName:"li",template:e.template(o),initialize:function(e){this.mode=e.mode,this.name=e.name,this.columnNames=e.columnNames},templateHelpers:function(){var e=this;return{e:e.model,mode:e.mode,name:e.name}}}),u=l.ItemView.extend({tagName:"li",template:e.template(s),initialize:function(e){this.mode=e.mode,this.name=e.name,this.columnNames=e.columnNames},templateHelpers:function(){var e=this;return{e:e.model,mode:e.mode,name:e.name,columnNames:e.columnNames}}}),h=l.CollectionView.extend({tagName:"ul",childView:c,childViewOptions:function(e,t){var a=this;return{mode:a.mode,name:a.name,columnNames:a.columnNames}},onRender:function(){var e=this;e.$el.attr("data-role","listview"),e.$el.attr("data-inset","true"),e.$el.attr("data-filter","true"),e.$el.attr("data-input","#troupes-summarize-characters-filter")},onDomRefresh:function(){}}),d=l.ItemView.extend({className:"ui-block-b",template:function(t){return e.template("<button><%= name %></button>")(t)},events:{click:"filterwith"},filterwith:function(){this.triggerMethod("filterwith",this.model)}}),f=(l.CollectionView.extend({className:"ui-grid-b ui-responsive",childView:d}),e.map(n.all_simpletrait_categories(),function(e){return{label:e[1],value:e[0]}})),p=r.Form.extend({fields:[{name:"category",label:"Category",control:"select",options:f},{name:"antecedence",label:"NPC, PC, Primary, or Secondary",control:"select",options:[{label:"All",value:"All"},{label:"NPC",value:"NPC"},{label:"PC of any type",value:"PC"},{label:"Primary PC",value:"Primary"},{label:"Secondary PC",value:"Secondary"}]},{name:"resulttype",label:"Which sort of results to show?",control:"select",options:[{label:"Only those with values in the category",value:"onlycat"},{label:"Only those with no values in the category",value:"nocat"},{label:"All",value:"all"}]},{name:"playable",label:"Only show playable characters",control:"checkbox"},{name:"format",label:"Format",control:"select",options:[{label:"Pretty",value:"pretty"},{label:"CSV",value:"csv"},{label:"CSV with Trait Grouping",value:"csvtraitgrouping"}]}]}),w=a.Model.extend({}),g=a.Collection.extend({model:w}),v=l.LayoutView.extend({el:"#troupe-summarize-characters-all > div[data-role='main']",regions:{sections:"#sections",list:"#troupe-summarize-characters-list"},childEvents:{filterwith:"filterwith"},filterwith:function(t){var a=this;a.list.currentView.mode=t.get("category");var i=e.find(n.all_simpletrait_categories(),function(e){return e[0]==t.get("category")});a.list.currentView.name=i[1],a.list.currentView.columnNames=a.getColumnNames(t.get("category"));var l=t.get("format");e.startsWith(l,"pretty")?a.list.currentView.childView=c:e.startsWith(l,"csvtraitgrouping")?a.list.currentView.childView=u:a.list.currentView.childView=m;var r=function(a,i,l){var n=a.get("antecedence");e.isUndefined(n)&&(n="Primary");var r=t.get("antecedence");if(!e.startsWith(r,"All"))if(e.startsWith(r,"NPC")){if(!e.startsWith(n,"NPC"))return!1}else if(e.startsWith(r,"PC")){if(e.startsWith(n,"NPC"))return!1}else if(!e.startsWith(n,r))return!1;var o=t.get("resulttype");if(e.startsWith(o,"onlycat")){if(!a.has(t.get("category")))return!1;if(0==a.get(t.get("category")).length)return!1}else if(e.startsWith(o,"nocat")&&a.has(t.get("category")))return!1;return!t.get("playable")||a.has("owner")};a.list.currentView.filter=r,a.collection.reset(e.map(a.collection.models))},getColumnNames:function(t){var a=this;return e(a.collection.models).map("attributes."+t).flatten().map("attributes.name").without(void 0).sortBy().uniq(!0).value()},setup:function(){var e=this,t=e.options||{};new g;return e.filterOptions=new a.Model({playable:!0,category:"attributes",antecedence:"PC",resulttype:"onlycat",format:"pretty"}),e.listenTo(e.filterOptions,"change",e.filterwith),e.showChildView("sections",new p({model:e.filterOptions}),t),e.showChildView("list",new h({collection:e.collection}),t),this.$el.enhanceWithin(),e}});return v});