define(["jquery","backbone","parse","backform","../forms/UserForm","text!../templates/profile-facebook-account.html","../helpers/PromiseFailReport","../helpers/InjectAuthData","marionette","../views/PatronagesView","../collections/Patronages","text!../templates/user-settings-profile.html","text!../templates/paypal-button.html"],function(e,t,n,r,i,a,s,l,o,u,m,c,d){var f=o.ItemView.extend({tagName:"form",template:_.template(""),initialize:function(){var a=this;a.errorModel=new t.Model,this.form=new i({errorModel:a.errorModel,model:n.User.current()||new t.Model,events:{change:function(e){e.preventDefault(),this.$("button[name=submit]").removeAttr("disabled");var t=this.fields.get("submit");"success"==t.get("status")&&(t.set({status:"",message:"",disabled:!1}),this.$el.enhanceWithin())},submit:function(t){var n=this;return t.preventDefault(),e.mobile.loading("show"),n.undelegateEvents(),n.model.errorModel.clear(),l(n.model),n.model.save().then(function(){n.fields.get("submit").set({status:"success",message:"Successfully Updated",disabled:!0}),n.$el.enhanceWithin()},function(e){n.fields.get("submit").set({status:"error",message:_.escape(e.message),disabled:!1}),n.$el.enhanceWithin()}).always(function(){e.mobile.loading("hide"),n.delegateEvents()}),!1}}}),a.form.fields.add(new r.Field({name:"submit",label:"Update",control:"button",disabled:!0,id:"submit"}))},onRender:function(){if(this.form.model!==n.User.current()){var e=this.form.model.errorModel;this.form.model=n.User.current(),this.form.model.errorModel=e}return this.form.setElement(this.$el),this.form.render(),this.$el.enhanceWithin(),this}}),h=(o.ItemView.extend({tagName:"div",template:_.template(a),events:{"click #facebook-unlink":"unlink","click #facebook-link":"link"},unlink:function(e){var t=this;e.preventDefault(),t.undelegateEvents(),n.User.current().set("authData",{facebook:null}),n.User.current().save().then(function(){t.delegateEvents(),t.render()}).fail(s)},link:function(e){var t=this;e.preventDefault(),t.undelegateEvents(),n.FacebookUtils.link(n.User.current(),"email").then(function(e){return hello("facebook").api("/me")}).then(function(e){t.delegateEvents(),t.render();var r=n.User.current();return r.has("email")||r.set("email",e.email),r.has("realname")||r.set("realname",e.name),l(r),r.save()}).fail(s)},onRender:function(){this.$el.enhanceWithin()}}),o.ItemView.extend({tagName:"div",template:_.template(d),templateHelpers:{userid:function(){return n.User.current().id}}}),o.ItemView.extend({template:function(e){return _.template("The one: <%= attributes.name %>")(e)}})),p=o.CollectionView.extend({tagName:"div",childView:h}),g=o.LayoutView.extend({el:"#user-settings-profile",template:_.template(c),regions:{profile:"#user-settings-profile-abs-form",roles:"#user-roles-available"},initialize:function(e){var t=this;t.patronages=new m},setup:function(){var e=this,r=e.options||{};e.render(),e.showChildView("profile",new f,r);var i=new t.Collection,a=new n.Query(n.Role);return a.each(function(e){var t=e.getUsers(),r=t.query();return r.equalTo("objectId",n.User.current().id),r.each(function(t){i.add(e)}).fail(function(t){console.log("Failed in promise for "+e.get("name"))})}).fail(s),e.showChildView("roles",new p({collection:i}),r),e.patronages.query.equalTo("owner",n.User.current()),e.patronages.fetch(),e}});return g});