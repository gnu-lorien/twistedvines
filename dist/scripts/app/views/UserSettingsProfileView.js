define(["jquery","backbone","parse","backform","../forms/UserForm","text!../templates/profile-facebook-account.html","../helpers/PromiseFailReport","../helpers/InjectAuthData","marionette","../views/PatronagesView","../collections/Patronages","text!../templates/user-settings-profile.html","text!../templates/test-paypal-button.html"],function(e,t,n,a,r,i,s,o,l,u,m,c,d){var f=l.ItemView.extend({tagName:"form",template:_.template(""),initialize:function(){var i=this;i.errorModel=new t.Model,this.form=new r({errorModel:i.errorModel,model:n.User.current()||new t.Model,events:{change:function(e){e.preventDefault(),this.$("button[name=submit]").removeAttr("disabled");var t=this.fields.get("submit");"success"==t.get("status")&&(t.set({status:"",message:"",disabled:!1}),this.$el.enhanceWithin())},submit:function(t){var n=this;return t.preventDefault(),e.mobile.loading("show"),n.undelegateEvents(),n.model.errorModel.clear(),o(n.model),n.model.save().then(function(){n.fields.get("submit").set({status:"success",message:"Successfully Updated",disabled:!0}),n.$el.enhanceWithin()},function(e){n.fields.get("submit").set({status:"error",message:_.escape(e.message),disabled:!1}),n.$el.enhanceWithin()}).always(function(){e.mobile.loading("hide"),n.delegateEvents()}),!1}}}),i.form.fields.add(new a.Field({name:"submit",label:"Update",control:"button",disabled:!0,id:"submit"}))},onRender:function(){if(this.form.model!==n.User.current()){var e=this.form.model.errorModel;this.form.model=n.User.current(),this.form.model.errorModel=e}return this.form.setElement(this.$el),this.form.render(),this.$el.enhanceWithin(),this}}),h=l.ItemView.extend({tagName:"div",template:_.template(i),events:{"click #facebook-unlink":"unlink","click #facebook-link":"link"},unlink:function(e){var t=this;e.preventDefault(),view.undelegateEvents(),n.User.current().set("authData",{facebook:null}),n.User.current().save().then(function(){t.delegateEvents(),t.render()}).fail(s)},link:function(e){var t=this;e.preventDefault(),t.undelegateEvents(),n.FacebookUtils.link(n.User.current(),"email").then(function(e){return hello("facebook").api("/me")}).then(function(e){t.delegateEvents(),t.render();var a=n.User.current();return a.has("email")||a.set("email",e.email),a.has("realname")||a.set("realname",e.name),o(a),a.save()}).fail(s)},onRender:function(){this.$el.enhanceWithin()}}),p=l.ItemView.extend({tagName:"div",template:_.template(d),templateHelpers:{userid:function(){return n.User.current().id}}}),g=l.LayoutView.extend({el:"#user-settings-profile",template:_.template(c),regions:{profile:"#user-settings-profile-abs-form",facebook:"#facebook-account-linking",patronage:"#usp-patronage-list-region",paypal:"#usp-paypal-button"},initialize:function(e){var t=this;t.patronages=new m},setup:function(){var e=this,t=e.options||{};return e.render(),e.showChildView("profile",new f,t),e.showChildView("facebook",new h,t),e.showChildView("paypal",new p,t),e.showChildView("patronage",new u({el:"#usp-patronage-list",collection:e.patronages}),t),e.patronages.query.equalTo("owner",n.User.current()),e.patronages.fetch(),e}});return g});