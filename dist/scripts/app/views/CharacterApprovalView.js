define(["jquery","backbone","moment","text!../templates/character-print-view.html","text!../templates/character-approval-view.html","../collections/Approvals","../models/Approval","text!../templates/character-approval-selected-view.html","../helpers/VampirePrintHelper","text!../templates/character-approval-edit.html"],function(e,r,a,t,n,i,d,o,s,c){var l=r.View.extend({initialize:function(){var e=this;_.bindAll(this,"render","format_simpletext","format_attribute_value","format_attribute_focus","format_skill","format_specializations"),e.sheetTemplate=_.template(t),e.approvalSelectedTemplate=_.template(o),e.editTemplate=_.template(c)},register:function(e){var r=this,a=Parse.Promise.as([]);if(e!==r.character){r.character&&(r.stopListening(r.character),r.character.recorded_changes&&r.stopListening(r.character.recorded_changes)),r.character=e,r.approvals=new i;var t=new Parse.Query(d);t.equalTo("owner",r.character),r.approvals.query=t,a=t.each(function(e){r.approvals.add(e),r.approval_index=r.approvals.length}),a.then(function(){return r.character.get_recorded_changes(function(e){r.listenTo(e,"add",r.render),r.listenTo(e,"reset",r.render),r.character.recorded_changes.length>0&&_.defer(r.render)})})}return a.then(function(){Parse.Promise.as(r)})},events:{"change #slider":"update_selected","change #sliderbaserange":"update_base_selected","change #approval-slider":"update_approval_selected","click .approve-change":"approve_change"},approve_change:function(){var e=this,r=e.character.recorded_changes.at(e.indexForPickedChange),a=new d({approved:!0,change:r,approver:Parse.User.current(),owner:e.character});a.save().then(function(r){return e.approvals.add(r),e.approval_index=e.approvals.length,e.indexForPickedChange=e.character.recorded_changes.models.length-1,e.render()})},format_entry:function(e,r){if(_.isUndefined(e))return console.log("Undefined log"),"Undefined log";if(e.get(r))return e.get(r);var t=e[r];return _.isDate(t)?a(t).format("lll"):t},format_approval:function(e,r){var a=e.get(r);return _.isUndefined(a)?_.result(e,r):_.has(a,"id")?a.id:a},_update_approval_selected:function(e){var r=this;r.approval_index=e,r.approved=r.approvals.models[r.approval_index],r.left_approval_index=r.approval_index-1,r.left_approval_index>=0?r.left_approved=r.approvals.models[r.left_approval_index]:r.left_approved=null;var a=0;if(r.approval_index<r.approvals.length)var t=_.findLast(r.character.recorded_changes.models,function(e,t){return e.id==r.approved.get("change").id&&(a=t,!0)});else a=r.character.recorded_changes.length-1;return r.indexForPickedChange=a,r.left_approval_index>=0?_.findLast(r.character.recorded_changes.models,function(e,a){return e.id==r.left_approved.get("change").id&&(r.left_rc_index=a+1,!0)}):r.left_rc_index=0,r.left_rc_index>=r.character.recorded_changes.models.length&&(r.no_changes_remaining=!0),r.$("#slider").val(a).slider("refresh"),r.$("#sliderbaserange").val(r.left_rc_index).slider("refresh"),t||_.last(r.character.recorded_changes.models)},_get_display_character:function(e){var r=this,a=_.chain(r.character.recorded_changes.models).takeRightWhile(function(r){return r.id!=e}).reverse().value(),t=r.character.get_transformed(a);if(r.transform_description){var n=_(r.transform_description).select({type:"removed"}).value();_.each(n,function(e){e.fake.is_deleted=!0,t.set(e.category,_.union(t.get(e.category),[e.fake]))})}return t},update_approval_selected:function(e){var r=this,a=_.parseInt(this.$(e.target).val()),t=r._update_approval_selected(a);r._update_transform_description(r.left_rc_index),r._render_viewing(!0),r._render_edit(!0);var n=r._get_display_character(t.id);r._render_sheet(n,!0)},update_selected:function(e){var r=this,a=_.parseInt(this.$(e.target).val());r.indexForPickedChange=a,r._update_transform_description(r.left_rc_index),r._render_viewing(!0),r._render_edit(!0);var t=this.$("#history-changes-"+a).val(),n=r._get_display_character(t);r._render_sheet(n,!0)},_update_transform_description:function(e){var r=this,a=_.chain(r.character.recorded_changes.models).takeRightWhile(function(r,a){return a!=e-1}).reverse().value(),t=r.character.get_transformed(a);r.transform_description=_.takeRight(t.transform_description,r.indexForPickedChange+1-e)},update_base_selected:function(e){var r=this,a=_.parseInt(this.$(e.target).val());r.left_rc_index=a,r._update_transform_description(r.left_rc_index),r._render_viewing(!0),r._render_edit(!0);var t=this.$("#history-changes-"+r.indexForPickedChange).val(),n=r._get_display_character(t);r._render_sheet(n)},_render_edit:function(e){var r=this,a=r.indexForPickedChange;_.isUndefined(a)&&(a=r.character.recorded_changes.models.length-1),this.$el.find("#approval-edit").html(this.editTemplate({character:this.character,logs:r.character.recorded_changes.models,format_entry:this.format_entry,format_approval:this.format_approval,indexForPickedChange:a,left_rc_index:r.left_rc_index,approval_index:r.approval_index,approvals:r.approvals.models,approval:r.approvals.models[r.approval_index],no_changes_remaining:r.no_changes_remaining})),e&&this.$el.find("#approval-edit").enhanceWithin()},_render_viewing:function(e){var r=this,a=r.indexForPickedChange;_.isUndefined(a)&&(a=r.character.recorded_changes.models.length-1),this.$el.find("#approval-viewing").html(this.approvalSelectedTemplate({character:this.character,logs:r.character.recorded_changes.models,format_entry:this.format_entry,format_approval:this.format_approval,indexForPickedChange:a,left_rc_index:r.left_rc_index,approval_index:r.approval_index,approvals:r.approvals.models,approval:r.approvals.models[r.approval_index]})),e&&this.$el.find("#approval-viewing").enhanceWithin()},_render_sheet:function(e,r){var a=this;a.character_override=e||a.character;var t=a.character_override,n=t.get_sorted_skills(),i=t.get_grouped_skills(n,3);this.$el.find("#approval-sheet").html(this.sheetTemplate({character:t,skills:n,groupedSkills:i,transform_description:a.transform_description,format_simpletext:this.format_simpletext,format_attribute_value:this.format_attribute_value,format_attribute_focus:this.format_attribute_focus,format_skill:this.format_skill,format_specializations:this.format_specializations})),r&&this.$el.find("#approval-sheet").enhanceWithin()},render:function(){var e=this;e.no_changes_remaining=!1;var r=e.indexForPickedChange;_.isUndefined(r)&&(r=e.character.recorded_changes.models.length-1),e._update_approval_selected(e.approvals.length),e._update_transform_description(e.left_rc_index),this.template=_.template(n)({character:this.character,logs:this.character.recorded_changes.models,format_entry:this.format_entry,format_approval:this.format_approval,indexForPickedChange:r,left_rc_index:e.left_rc_index,approval_index:e.approval_index,approvals:e.approvals.models,approval:e.approvals.models[e.approval_index]}),this.$el.find("#approval-main").html(this.template),this._render_viewing(),this._render_edit();var a=this.$("#history-changes-"+e.indexForPickedChange).val(),t=e._get_display_character(a);return e._render_sheet(t),this.$el.enhanceWithin(),this}});return _.extend(l.prototype,s),l});