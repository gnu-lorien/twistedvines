define(["jquery","backbone","parse","backform","../forms/UserForm","marionette","../views/PatronagesView","../collections/Patronages"],function(e,t,n,i,r,s,a,o){var l=s.ItemView.extend({tagName:"form",template:_.template(""),initialize:function(){var s=this;s.errorModel=new t.Model,this.form=new r({errorModel:s.errorModel,model:new t.Model,events:{submit:function(t){var i=this;t.preventDefault(),i.undelegateEvents(),e.mobile.loading("show");var r=i.model;new n.Query(n.Role).equalTo("name","Administrator").first().then(function(e){return r.get("admininterface")?e.getUsers().add(r):e.getUsers().remove(r),e.save()}).then(function(){r.get("admininterface")?i.fields.get("submit").set({status:"success",message:"Made them an admin!"}):i.fields.get("submit").set({status:"success",message:"Removed their admin privileges!"})}).fail(function(e){i.fields.get("submit").set({status:"error",message:_.escape(e.message)})}).always(function(){i.$el.enhanceWithin(),e.mobile.loading("hide"),i.delegateEvents()})}}}),s.form.fields.each(function(e){e.set("disabled",!0)}),s.form.fields.add(new i.Field({name:"admininterface",label:"Administrator",control:"checkbox"})),s.form.fields.add(new i.Field({name:"submit",label:"Update",control:"button",id:"submit"}))},register:function(e){var t=this;if(t.user=e,t.form.model.id!=e.id){t.form.fields.get("submit").set({status:"",message:""});var i=new n.Query(n.Role).equalTo("users",e).equalTo("name","Administrator"),r=new n.Query(n.Role).equalTo("users",e).equalTo("name","SiteAdministrator"),s=n.Query.or(i,r);return s.count().then(function(n){e.set("admininterface",!!n);var i=t.form.errorModel;return t.form.model=e,t.form.model.errorModel=i,t.render()})}},onRender:function(){return this.form.setElement(this.$el),this.form.render(),this.$el.enhanceWithin(),this}}),d=s.ItemView.extend({tagName:"div",template:function(e){return _.template("<button>Reset Password</button><p class='message'></p>")(e)},events:{click:function(t){t.preventDefault();var i=this,r=i.model.get("email"),s=i.$("button"),a=i.$(".message");e.mobile.loading("show"),i.undelegateEvents(),s.attr("disabled",!0),n.User.requestPasswordReset(r).then(function(){a.text("Password Reset Email Sent")},function(e){a.text(_.escape(e.message))}).always(function(){i.$el.enhanceWithin(),i.$("button").removeAttr("disabled"),e.mobile.loading("hide"),i.delegateEvents()})}}}),m=(s.ItemView.extend({tagName:"div",template:function(e){return _.template("<a href='#administration/patronages/new/<%= userid %>'>Add New Patronage</a>")(e)},modelEvents:{change:"render"}}),s.ItemView.extend({template:function(e){return _.template("The one: <%= attributes.name %>")(e)}})),u=s.CollectionView.extend({tagName:"div",childView:m}),c=s.LayoutView.extend({el:"#administration-user-view",regions:{profile:"#abs-form",password:"#reset-password-view",roles:"#administration-user-roles-available"},initialize:function(e){var n=this;n.patronages=new o,n.showChildView("profile",new l,e),n.showChildView("password",new d,e),n.roles=new t.Collection,n.showChildView("roles",new u({collection:n.roles}),e)},register:function(e){var t=this;t.profile.currentView.register.apply(t.profile.currentView,arguments),t.password.currentView.model=e;var i=new n.Query(n.Role);i.each(function(n){var i=n.getUsers(),r=i.query();return r.equalTo("objectId",e.id),r.each(function(e){t.roles.add(n)}).fail(function(e){console.log("Failed in promise for "+n.get("name"))})})}});return c});