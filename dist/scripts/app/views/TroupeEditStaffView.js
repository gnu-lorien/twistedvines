define(["jquery","backbone","parse","backform","../helpers/PromiseFailReport"],function(e,r,n,t,o){var i=r.View.extend({initialize:function(){_.bindAll(this,"render","submit")},register:function(e,r){var o=this;o.troupe=e,o.user=r;var i={};return n.Promise.when(o.troupe.get_roles()).then(function(e){i=e;var r=_.map(o.troupe.title_options,function(e){var r=i[e].getUsers(),n=r.query();return n.equalTo("objectId",o.user.id),n.count().then(function(r){i[e]=r,console.log("Setting up role "+e+" count with "+r)})});return n.Promise.when(r)}).then(function(){var e=_.findKey(i,function(e,r,n){return console.log("Got "+e+" for "+r),!!(_.isFinite(e)&&e>0)});return console.log("I found this user with a role of "+e),n.Promise.as(e)}).then(function(e){o.user.set("role",e||"None"),o.form=new t.Form({el:"#troupe-edit-staff-form",model:o.user,fields:[{name:"username",label:"Username",control:"uneditable-input"},{name:"realname",label:"Name",control:"uneditable-input"},{name:"role",label:"Role",control:"select",options:[{label:"Lead Storyteller",value:"LST"},{label:"Assistant Storyteller",value:"AST"},{label:"Narrator",value:"Narrator"},{label:"Not on Staff",value:"None"}]},{control:"spacer"},{control:"button",label:"Save"}]}),o.render()}).fail(function(e){_.isArray(e)?_.each(e,function(e){console.log("Something failed"+e.message)}):console.log("error updating experience"+e.message)})},events:{submit:"submit"},submit:function(e){var r=this;e.preventDefault();var t=r.user.get("role"),i=_.slice(r.troupe.title_options),l=[];"None"!=t&&(l.push(t),i=_.xor(i,l));var a=function(e){_.each(i,function(n){var t=e[n].getUsers();console.log(t),t.remove(r.user)}),_.each(l,function(n){e[n].getUsers().add(r.user)});var t=_.values(e),a=_.map(t,function(e){return e.save().fail(o)});return n.Promise.when(a)};return n.Promise.when(r.troupe.get_roles()).then(a).then(function(){return r.troupe.get_generic_roles()}).then(a).always(function(){window.location.hash="#troupe/"+r.troupe.id}).fail(o)},render:function(){var e=this;return e.form.render(),this.$el.enhanceWithin(),this}});return i});