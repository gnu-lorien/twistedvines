define(["underscore","jquery","parse","../models/SimpleTrait","../models/VampireChange","../models/VampireCreation","../collections/VampireChangeCollection","../collections/ExperienceNotationCollection","../models/ExperienceNotation","../helpers/BNSMETV1_VampireCosts","../helpers/PromiseFailReport","../helpers/ExpirationMixin","../helpers/UserWreqr","../models/FauxSimpleTrait","../collections/Approvals","../models/Approval"],function(e,t,n,r,i,a,o,s,c,u,_,d,p,g,l,h){var m=e.extend({remove_trait:function(e){var t=this;return e.destroy().then(function(){var n={alteration_spent:(e.get("cost")||0)*-1,reason:"Removed "+e.get("name")};return t.remove(e.get("category"),e),t.increment("change_count"),t.add_experience_notation(n)})},ensure_category:function(e){this.has(e)||this.set(e,[])},get_troupe_ids:function(){return this.troupe_ids},get_me_acl:function(){var t=this,r=new n.ACL;r.setPublicReadAccess(!1),r.setPublicWriteAccess(!1);var i=t.get("owner");return e.isUndefined(i)?(r.setReadAccess(n.User.current(),!0),r.setWriteAccess(n.User.current(),!0)):(r.setReadAccess(i,!0),r.setWriteAccess(i,!0)),r.setRoleReadAccess("Administrator",!0),r.setRoleWriteAccess("Administrator",!0),e.each(t.troupe_ids,function(e){r.setRoleReadAccess("LST_"+e,!0),r.setRoleWriteAccess("LST_"+e,!0),r.setRoleReadAccess("AST_"+e,!0),r.setRoleWriteAccess("AST_"+e,!0)}),r},set_cached_acl:function(e){var t=this;e=e||t.get_me_acl(),t.set("acl_to_json",JSON.stringify(e.toJSON()))},get_category_for_fetch:function(t){var n=this,r=n.get(t);return e.filter(r,function(t){return!e.isUndefined(t.id)})},update_trait:function(t,i,a,o,s,c,u){var d,p,g=this;return e.isString(t)?p=t:(d=t,a=d.get("category")),e.isUndefined(s)&&(s=!0),g.ensure_category(a),n.Object.fetchAllIfNeeded(g.get_category_for_fetch(a)).then(function(){if(e.isString(t)){d=new r,e.each(g.get(a),function(t){e.isEqual(t.get("name"),p)&&(d=t)}),d.setACL(g.get_me_acl());var l=n.Object.extend("Vampire");d.set({name:p,value:i||o,category:a,owner:new l({id:g.id}),free_value:o||0}),c&&(d.set("experience_cost_type",c),d.set("experience_cost_modifier",e.parseInt(u)))}else{if(!e.contains(g.get(a),d))return n.Promise.error({code:0,message:"Provided trait not already in Vampire as expected"});if(d.dirty("name")){var h=e.select(e.without(g.get(a),d),"attributes.name",d.get("name"));if(0!=h.length)try{return d.set("name",d._serverData.name),n.Promise.error({code:1,message:"Name matches an existing trait. Restoring original name"})}catch(m){return n.Promise.error({code:2,message:"Name matches an existing trait. Failed to restore original name. "+m})}}}var f=g.calculate_trait_cost(d),v=g.calculate_trait_to_spend(d);e.isFinite(v)||(v=0),d.set("cost",f),g.increment("change_count"),g.addUnique(a,d,{silent:!0});var x,y=g._update_creation(a,d,o).then(function(){return g.save()}).then(function(){return 0!=v?g.add_experience_notation({alteration_spent:v,reason:"Update "+d.get("name")+" to "+d.get("value")}):n.Promise.as()}).then(function(){return console.log("Finished saving character"),n.Promise.as(g)}).fail(function(e){console.log("Failing to save vampire because of "+JSON.stringify(e)),_(e)});return x=s?y:n.Promise.as(g),x.then(function(){return g.trigger("change:"+a),n.Promise.as(d,g)})})},update_text:function(e,t){var r=this;return r.set(e,t),r.save().then(function(){return n.Object.fetchAllIfNeeded([r.get("creation")]).then(function(t){var i=t[0];return i.get(e)?n.Promise.as(r):(i.set(e,!0),i.save().then(function(){return n.Promise.as(r)}))})}).fail(_)},get_trait_by_name:function(t,r){var i=this,a=i.get(t);r=""+r;var o=e.find(a,"attributes.name",r);return n.Promise.as(o,i)},get_trait:function(t,r){var i=this,a=i.get(t);e.isObject(r)&&(r=r.id||r.cid);var o=e.findWhere(a,{cid:r});if(o)return n.Promise.as(o,i);o=e.findWhere(a,{id:r});try{var s=n.Object.fetchAllIfNeeded([o])}catch(c){return c instanceof TypeError?(console.log("Caught a typeerror indicating this object is still saving "+c.message),console.log(JSON.stringify(o)),console.log(JSON.stringify(a)),o.save().then(function(e){return n.Promise.as(e,i)})):n.Promise.reject(c)}return s.then(function(e){return n.Promise.as(e[0],i)})},unpick_from_creation:function(t,r,i,a){var o=this;return o.fetch_all_creation_elements().then(function(){return o.get_trait(t,r)}).then(function(r){var s=t+"_"+i+"_picks",c=t+"_"+i+"_remaining",u=o.get("creation");if(u.remove(s,r),e.contains(o.get_sum_creation_categories(),t)){var _=e.sum(u.get(s),"attributes.value");u.set(c,7-_)}else u.increment(c,1);var d=n.Promise.when(u.save(),o.remove_trait(r));return a?d.then(function(){return n.Promise.as(o)}):n.Promise.as(o)})},is_being_created:function(){return!this.get("creation").get("completed")},complete_character_creation:function(){var e=this;return e.fetch_all_creation_elements().then(function(){var t=e.get("creation");return t.set("completed",!0),t.save()})},health_levels:function(){var t=this,n=["Healthy","Injured","Incapacitated"],r={},i=[];return e.each(t.get("health_levels"),function(e){r[e.get("name")]=e.get("value")}),e.each(n,function(e){i.push([e,r[e]])}),i},experience_available:function(){var e=this;return e.get("experience_earned")-e.get("experience_spent")},get_experience_notations:function(t,r){var i=this;return e.isUndefined(i.experience_notations)?(i.experience_notations=new s,i.experience_notations.on("change",i.on_update_experience_notation,i),i.experience_notations.on("remove",i.on_remove_experience_notation,i),t&&t(i.experience_notations),i.fetch_experience_notations()):(t&&t(i.experience_notations),r&&r(i.experience_notations),n.Promise.as(i.experience_notations))},fetch_experience_notations:function(){var e=this;return e._experienceNotationsFetch=e._experienceNotationsFetch||n.Promise.as(),e._experienceNotationsFetch=e._experienceNotationsFetch.always(function(){var t=new n.Query(c);return t.equalTo("owner",e).addDescending("entered").addDescending("createdAt"),e.experience_notations.query=t,e.experience_notations.fetch({reset:!0})}),e._experienceNotationsFetch},wait_on_current_experience_update:function(){var e=this;return e._propagateExperienceUpdate||n.Promise.as()},_finalize_triggered_experience_notation_changes:function(t,r){var i=this,a=i._propagate_experience_notation_change(i.experience_notations,t);return i._propagateExperienceUpdate=i._propagateExperienceUpdate||n.Promise.as(),i._propagateExperienceUpdate=i._propagateExperienceUpdate.done(function(){return n.Object.saveAll(a)}).done(function(){i.trigger("finish_experience_notation_propagation")}).fail(function(t){e.isArray(t)?e.each(t,function(e){console.log("Something failed"+e.message)}):console.log("error updating experience"+t.message)}),i._propagateExperienceUpdate},on_remove_experience_notation:function(e,t,n){var r=this;return r._finalize_triggered_experience_notation_changes(n.index,t)},on_update_experience_notation:function(e,t,r){var i,a=this,o=!1;n.Promise.as([]);r=r||{};var s=t.changes;return s.entered&&(o=!0,a.experience_notations.sort()),(s.alteration_earned||s.alteration_spent)&&(o=!0),o?(i=a.experience_notations.indexOf(e),a._finalize_triggered_experience_notation_changes(i,a.experience_notations)):n.Promise.as([])},_default_experience_notation:function(t){var n=this,r=e.defaults(t||{},{entered:new Date,reason:"Unspecified reason",earned:0,spent:0,alteration_earned:0,alteration_spent:0,owner:n}),i=new c(r);return i.setACL(n.get_me_acl()),i},_propagate_experience_notation_change:function(t,n){var r=this;r.trigger("begin_experience_notation_propagation");var i;i=n+1<t.models.length?t.at(n+1):r._default_experience_notation();var a=[],o=e.reduceRight(e.slice(t.models,0,n+1),function(e,t,n,r){var i=t.get("alteration_earned")+e.get("earned");t.set("earned",i,{silent:!0});var o=t.get("alteration_spent")+e.get("spent");return t.set("spent",o,{silent:!0}),a.push(t),t},i);return r.set("experience_earned",o.get("earned")),r.set("experience_spent",o.get("spent")),a.push(r),a},add_experience_notation:function(e){var t=this;return t._addExperienceEntryWrapper=t._addExperienceEntryWrapper||n.Promise.as(),t._addExperienceEntryWrapper=t._addExperienceEntryWrapper.always(function(){return t.get_experience_notations()}).then(function(r){var i=t._default_experience_notation(e);r.add(i,{silent:!0});for(var a,o,s=0,c=r.models.length;s<c;s++)if(o=r.models[s],r._byCid[o.cid]){a=s;break}var u=t._propagate_experience_notation_change(r,a);return n.Object.saveAll(u).then(function(){o.trigger("add",o,r,{index:a}),t.trigger("finish_experience_notation_propagation")})}),t._addExperienceEntryWrapper},remove_experience_notation:function(t,r){var r,t,i=this;r=r||{},t=e.isArray(t)?t.slice():[t];var a=t[0],o=a;return i.get_experience_notations().then(function(e){var t=e.indexOf(a);e.remove(a,{silent:!0});var r=i._propagate_experience_notation_change(e,t);return n.Promise.when(a.destroy(),n.Object.saveAll(r)).then(function(){o.trigger("remove",o,e,{index:t}),i.trigger("finish_experience_notation_propagation")})})},get_recorded_changes:function(t){var n=this;if(!e.isUndefined(n.recorded_changes)){var r=n.update_recorded_changes();return t&&r.then(function(e){t(e)}),r}return n.recorded_changes=new o,n.on("saved",n.update_recorded_changes,n),t&&t(n.recorded_changes),n.fetch_recorded_changes()},update_recorded_changes:function(){var t=this;return 0==t.recorded_changes.models.length?t.fetch_recorded_changes():(t._recordedChangesFetch=t._recordedChangesFetch||n.Promise.as(),t._recordedChangesFetch=t._recordedChangesFetch.always(function(){var r=e.last(t.recorded_changes.models).createdAt,a=new n.Query(i);return a.equalTo("owner",t).addAscending("createdAt").limit(1e3),a.greaterThan("createdAt",r),t.recorded_changes.query=a,t.recorded_changes.fetch({add:!0})}),t._recordedChangesFetch)},fetch_recorded_changes:function(){var e=this;return e._recordedChangesFetch=e._recordedChangesFetch||n.Promise.as(),e._recordedChangesFetch=e._recordedChangesFetch.always(function(){console.log("Resetting recorded changes");var t=new n.Query(i);return t.equalTo("owner",e).addAscending("createdAt").limit(1e3),e.recorded_changes.query=t,e.recorded_changes.fetch({reset:!0})}),e._recordedChangesFetch},get_approvals:function(){var t=this;return t._approvalsFetch=t._approvalsFetch||n.Promise.as(),t._approvalsFetch=t._approvalsFetch.always(function(){e.isUndefined(t.approvals)&&(t.approvals=new l);var r=new n.Query(h);return r.equalTo("owner",t),0!=t.approvals.length&&r.greaterThan("createdAt",t.approvals.last().createdAt),r.each(function(e){t.approvals.add(e)})}).then(function(){return n.Promise.as(t.approvals)}),t._approvalsFetch},get_transformed_last_approved:function(){var t=this;return t.get_approvals().then(function(){return t.get_recorded_changes()}).then(function(){var r=t.approvals.last().get("change").id,i=e.chain(t.recorded_changes.models).takeRightWhile(function(e){return e.id!=r}).reverse().value(),a=t.get_transformed(i);return n.Promise.as(a)})},get_transformed:function(t){var n=!e.isUndefined(this.troupes),r=this.clone();n&&(this.troupes.parent=null);var i=[];return e.each(t,function(t){if("core"!=t.get("category")){var n=t.get("category"),a=e.find(r.get(n),function(n){return e.isUndefined(n)&&console.log("Something went wrong fetching the full character object and now a name is undefined"),e.isEqual(n.get("name"),t.get("name"))}),o=new g({name:t.get("old_text")||t.get("name"),free_value:t.get("free_value"),value:t.get("old_value")||t.get("value"),cost:t.get("old_cost")||t.get("cost"),category:t.get("category")});"update"==t.get("type")?(r.set(n,e.xor(r.get(n),[a,o])),i.push({category:n,name:t.get("name"),fake:o,type:"changed"})):"define"==t.get("type")?(r.set(n,e.without(r.get(n),a)),i.push({category:n,name:o.get("name"),fake:void 0,type:"define"})):"remove"==t.get("type")&&(r.set(n,e.union(r.get(n),[o])),i.push({category:n,name:o.get("name"),fake:o,type:"removed"}))}else"core_define"==t.get("type")?(r.set(t.get("name"),void 0),i.push({category:t.get("category"),name:t.get("name"),old_text:void 0,type:"define"})):"core_update"==t.get("type")&&(r.set(t.get("name"),t.get("old_text")),i.push({category:t.get("category"),name:t.get("name"),old_text:t.get("old_text"),type:"update"}))}),r.transform_description=i,r},get_sorted_skills:function(){var t=this,n=t.get("skills");return n=e.sortBy(n,"attributes.name")},get_grouped_skills:function(t,n){var r=this,t=t||r.get_sorted_skills(),n=n||3,i={0:[],1:[],2:[]},a=e.ceil(t.length/n);return e.each(e.range(n),function(n){i[n]=e.take(t,a),t=e.drop(t,a)}),i=e.zip(i[0],i[1],i[2])},get_thumbnail:function(e){var t=this;if(t.get("portrait")){var r=t.get("portrait");return r.fetch().then(function(r){return console.log(t.get_thumbnail_sync(e)),n.Promise.as(r.get("thumb_"+e).url())})}return n.Promise.as("head_skull.png")},get_thumbnail_sync:function(t){var n=this;return e.result(n,"attributes.portrait.attributes.thumb_"+t+".url","head_skull.png")},get_willpower_total:function(){var t=this,n=t.get("willpower_sources"),r=e.sum(n,"attributes.value");return r},archive:function(){var e=this;return e.unset("owner"),e.save()},initialize_troupe_membership:function(){var t=this;t.troupe_ids=[],e.isUndefined(t.troupes)?(t.troupes=t.relation("troupes"),t.troupes.targetClassName="Troupe"):e.isNull(t.troupes.parent)&&(t.troupes.parent=t);var r=t.troupes.query();return r.each(function(e){t.troupe_ids.push(e.id)}).then(function(){return n.Promise.as(t)})},broken_update_troupe_acls:function(){var e=this,r=[],i=e.get_me_acl();return t.mobile.loading("show",{text:"Updating character permissions",textVisible:!0}),e.set_cached_acl(i),e.setACL(i),e.save().then(function(){t.mobile.loading("show",{text:"Updating trait permissions",textVisible:!0});var i=new n.Query("SimpleTrait");return i.equalTo("owner",e),i.each(function(t){t.setACL(e.get_me_acl()),r.push(t)})}).then(function(){return t.mobile.loading("show",{text:"Saving trait permissions",textVisible:!0}),n.Object.saveAll(r)}).then(function(){return t.mobile.loading("show",{text:"Fetching experience notations",textVisible:!0}),n.Promise.error()}).then(function(r){return t.mobile.loading("show",{text:"Updating experience notations",textVisible:!0}),r.each(function(t){t.setACL(e.get_me_acl())}),n.Object.saveAll(r.models)}).then(function(){return t.mobile.loading("show",{text:"Updating server side change log",textVisible:!0}),n.Cloud.run("update_vampire_change_permissions_for",{character:e.id})})},progress:function(n){e.isUndefined(t)||e.isUndefined(t.mobile)||e.isUndefined(t.mobile.loading)?console.log("Progress: "+n):t.mobile.loading("show",{text:n,textVisible:!0})},update_troupe_acls:function(){var e=this,t=[],r=e.get_me_acl();return e.progress("Updating character permissions"),e.set_cached_acl(r),e.setACL(r),e.save().then(function(){e.progress("Updating trait permissions"),delete e.attributes.troupes,delete e.troupes,delete e._previousAttributes.troupes,delete e._serverData.troupes;var r=new n.Query("SimpleTrait");return r.equalTo("owner",e),r.each(function(n){n.setACL(e.get_me_acl()),t.push(n)})}).then(function(){return e.progress("Saving trait permissions"),n.Object.saveAll(t)}).then(function(){return e.progress("Fetching experience notations"),e.get_experience_notations()}).then(function(t){return e.progress("Updating experience notations"),t.each(function(t){t.setACL(e.get_me_acl())}),n.Object.saveAll(t.models)}).then(function(){return e.progress("Updating server side change log"),n.Cloud.run("update_vampire_change_permissions_for",{character:e.id})}).then(function(){return e.progress("Finishing up!"),n.Promise.as(e)})},join_troupe:function(e){var t=this;return t.initialize_troupe_membership().then(function(){return t.troupes.add(e),t.troupe_ids.push(e.id),t.update_troupe_acls()})},leave_troupe:function(t){var n=this;return n.initialize_troupe_membership().then(function(){return n.troupes.remove(t),n.troupe_ids=e.remove(n.troupe_ids,t.id),n.update_troupe_acls()})},get_owned_ids:function(){var t=this,r={SimpleTrait:[],ExperienceNotation:[],VampireChange:[]},i=t;return n.Promise.when(e.map(["SimpleTrait","ExperienceNotation","VampireChange"],function(e){var t=new n.Query(e).equalTo("owner",i).select("id");return t.each(function(t){r[e].push(t.id)})})).then(function(){return n.Promise.as(r)})},update_server_client_permissions_mismatch:function(){var t=this;return t._mismatchFetch=t._mismatchFetch||n.Promise.as(),t._mismatchFetch=t._mismatchFetch.always(function(){return n.Promise.when(t.get_owned_ids(),n.Cloud.run("get_expected_vampire_ids",{character:t.id})).then(function(r,i){return e.eq(r,i)?t.is_mismatched=!1:t.is_mismatched=!0,n.Promise.as(t)})}),t._mismatchFetch},check_server_client_permissions_mismatch:function(){return e.isUndefined(this.is_mismatched)?this.update_server_client_permissions_mismatch():n.Promise.as(this)}},d),f=n.Object.extend("Vampire",m);return f});