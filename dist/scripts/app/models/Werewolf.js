define(["underscore","jquery","parse","../models/SimpleTrait","../models/VampireChange","../models/VampireCreation","../collections/VampireChangeCollection","../collections/ExperienceNotationCollection","../models/ExperienceNotation","../helpers/BNSWTAV1_WerewolfCosts","../helpers/PromiseFailReport","../helpers/ExpirationMixin","../helpers/UserWreqr","../models/Character"],function(e,t,i,n,a,r,s,c,o,u,l,_,f,d){var h=[["attributes","Attributes","Attributes"],["focus_physicals","Physical Focus","Attributes"],["focus_mentals","Mental Focus","Attributes"],["focus_socials","Social Focus","Attributes"],["health_levels","Health Levels","Expended"],["willpower_sources","Willpower","Expended"],["wta_gnosis_sources","Gnosis","Expended"],["skills","Skills","Skills"],["lore_specializations","Lore Specializations","Skills"],["academics_specializations","Academics Specializations","Skills"],["drive_specializations","Drive Specializations","Skills"],["linguistics_specializations","Languages","Skills"],["wta_gifts","Gifts","Gifts"],["extra_affinity_links","Extra Affinities","Gifts"],["wta_backgrounds","Backgrounds","Backgrounds"],["wta_territory_specializations","Territory Specializations","Backgrounds"],["contacts_specializations","Contacts Specializations","Backgrounds"],["allies_specializations","Allies Specializations","Backgrounds"],["influence_elite_specializations","Influence: Elite","Backgrounds"],["influence_underworld_specializations","Influence: Underworld","Backgrounds"],["wta_rites","Rites","Backgrounds"],["wta_monikers","Monikers","Backgrounds"],["wta_merits","Merits","Merits and Flaws"],["wta_flaws","Flaws","Merits and Flaws"],["wta_totem_bonus_traits","Totem Bonuses","Pack"]],g=["archetype","wta_breed","wta_auspice","wta_tribe","wta_camp","wta_faction","antecedence"],w=["wta_merits","wta_flaws"],m=e.extend({get_sum_creation_categories:function(){return w},_update_creation:function(t,n,a){var r=this;return(e.contains(["wta_merits","wta_flaws"],t)||a)&&e.contains(["wta_flaws","wta_merits","focus_mentals","focus_physicals","focus_socials","attributes","skills","wta_gifts","wta_backgrounds"],t)?i.Object.fetchAllIfNeeded([r.get("creation")]).then(function(s){var c=s[0],o=t+"_"+a+"_remaining",u=t+"_"+a+"_picks";if(c.addUnique(u,n),e.contains(["wta_merits","wta_flaws"],t)){var l=e.sum(c.get(u),"attributes.value");c.set(o,7-l)}else c.increment(o,-1);return i.Promise.as(r)}):i.Promise.as(r)},ensure_creation_rules_exist:function(){var e=this;if(e.has("creation"))return i.Object.fetchAllIfNeeded([e.get("creation")]).then(function(){return i.Promise.as(e)},function(e){console.log("ensure_creation_rules_exist",e)});var t=new r({owner:e,completed:!1,concept:!1,archetype:!1,clan:!1,attributes:!1,focuses:!1,skills_4_remaining:1,skills_3_remaining:2,skills_2_remaining:3,skills_1_remaining:4,wta_backgrounds_3_remaining:1,wta_backgrounds_2_remaining:1,wta_backgrounds_1_remaining:1,wta_gifts_1_remaining:3,attributes_7_remaining:1,attributes_5_remaining:1,attributes_3_remaining:1,focus_mentals_1_remaining:1,focus_socials_1_remaining:1,focus_physicals_1_remaining:1,wta_merits_0_remaining:7,wta_flaws_0_remaining:7,phase_1_finished:!1,initial_xp:30,phase_2_finished:!1});return t.save().then(function(t){return e.set("creation",t),e.add_experience_notation({reason:"Character Creation XP",alteration_earned:30,earned:30})}).then(function(t){return i.Promise.as(e)})},fetch_all_creation_elements:function(){var t=this;return t.ensure_creation_rules_exist().then(function(){var n=t.get("creation"),a=["wta_flaws","wta_merits","focus_mentals","focus_physicals","focus_socials","attributes","skills","wta_backgrounds","wta_gifts"],r=[];return e.each(a,function(t){e.each(e.range(-1,10),function(i){var a=t+"_"+i+"_picks";r=e.union(n.get(a),r)})}),r=e.chain(r).flatten().without(void 0).filter(function(e){return e.id}).value(),i.Object.fetchAllIfNeeded(r).then(function(){return i.Promise.as(t)})})},all_simpletrait_categories:function(){return h},all_text_attributes:function(){return g},_raw_rank:function(){var t,i=this;return e.each(i.get("wta_backgrounds"),function(e){"Rank"==e.get_base_name()&&(t=e.get("value"))}),t},rank:function(){return this._raw_rank()||0},has_rank:function(){return!e.isUndefined(this._raw_rank())},get_gnosis_total:function(){var t=this,i=t.get("wta_gnosis_sources"),n=e.sum(i,"attributes.value");return n},calculate_trait_cost:function(e){var t=this;return t.Costs.calculate_trait_cost(t,e)},calculate_trait_to_spend:function(e){var t=this,i=t.Costs.calculate_trait_cost(t,e),n=e.get("cost")||0;return i-n},calculate_total_cost:function(){var t=this,n=["skills","wta_backgrounds","wta_gifts","attributes","wta_merits"],a={},r=e.chain(n).map(function(e){return t.get(e)}).flatten().without(void 0).value();return i.Object.fetchAllIfNeeded(r).then(function(n){return e.each(n,function(e){a[e.get("category")+"-"+e.get("name")]={trait:e,cost:t.calculate_trait_cost(e)}}),i.Promise.as(a)})},max_trait_value:function(e){return"skills"==e.get("category")?10:20},initialize_costs:function(){var t=this;return e.isUndefined(t.Costs)?(t.Costs=new u,t.Costs.initialize().then(function(){return i.Promise.as(t)})):i.Promise.as(t)},get_affinities:function(){var t=this,i=[t.get("wta_tribe"),t.get("wta_auspice"),t.get("wta_breed")];i=e.without(i,void 0);var n=e.map(t.get("extra_affinity_links"),"attributes.name");return n=e.without(n,void 0),[].concat(i,n)}},_);e.extend(m,d);var p=i.Object.extend("Vampire",m);p.get_character=function(t,n,a){if(e.isUndefined(a)&&(a={_character:null}),n=n||[],e.isString(n)&&(n=[n]),null===a._character){var r=new i.Query(p);return r.include("portrait"),r.include("owner"),r.include("wta_backgrounds"),r.include("extra_affinity_links"),r.get(t).then(function(e){return a._character=e,p.get_character(t,n,a)})}if(a._character.id!=t)return a._character.save().then(function(){return a._character=null,p.get_character(t,n,a)});if("all"==n&&(n=e.result(a._character,"all_simpletrait_categories",[]),n=e.map(n,function(e){return e[0]})),0!==n.length){var s=e.chain(n).map(function(e){return a._character.get(e)}).flatten().without(void 0).filter(function(e){return e.id}).value();return i.Object.fetchAllIfNeeded(s).done(function(){return p.get_character(t,[],a)})}return a._character.ensure_creation_rules_exist().then(function(e){return a._character.initialize_costs()}).then(function(e){return a._character.initialize_troupe_membership()})};var k=function(i){e.isUndefined(t)||e.isUndefined(t.mobile)||e.isUndefined(t.mobile.loading)?console.log("Progress: "+i):t.mobile.loading("show",{text:i,textVisible:!0})};return p.create=function(t){var n,a=new p,r=new i.ACL;return r.setPublicReadAccess(!1),r.setPublicWriteAccess(!1),r.setWriteAccess(i.User.current(),!0),r.setReadAccess(i.User.current(),!0),r.setRoleReadAccess("Administrator",!0),r.setRoleWriteAccess("Administrator",!0),a.setACL(r),k("Fetching patronage status"),f.get_latest_patronage(i.User.current()).then(function(n){var r={name:t,type:"Werewolf",owner:i.User.current(),change_count:0};return n&&e.extend(r,{expiresOn:n.get("expiresOn")}),k("Saving base character"),a.save(r)}).then(function(){return k("Fetching character from server"),p.get_character(a.id)}).then(function(e){return n=e,k("Adding Healthy"),n.update_trait("Healthy",3,"health_levels",3,!0)}).then(function(){return k("Adding Injured"),n.update_trait("Injured",3,"health_levels",3,!0)}).then(function(){return k("Adding Incapacitated"),n.update_trait("Incapacitated",3,"health_levels",3,!0)}).then(function(){return k("Adding Willpower"),n.update_trait("Willpower",6,"willpower_sources",6,!0)}).then(function(){return k("Adding Gnosis"),n.update_trait("Gnosis",10,"wta_gnosis_sources",6,!0)}).then(function(){return k("Done!"),i.Promise.as(n)})},p.create_test_character=function(e){var e=e||"",t="karmacharactertestwerewolf"+e+Math.random().toString(36).slice(2);return p.create(t)},p.all_simpletrait_categories=function(){return h},p.all_text_attributes=function(){return g},p});