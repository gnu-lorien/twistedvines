define(["underscore","jquery","parse","../models/SimpleTrait","../models/VampireChange","../models/VampireCreation","../collections/VampireChangeCollection","../collections/ExperienceNotationCollection","../models/ExperienceNotation","../helpers/BNSMETV1_VampireCosts","../helpers/PromiseFailReport","../helpers/ExpirationMixin","../helpers/UserWreqr","../models/Character"],function(e,t,i,n,r,a,s,c,l,o,u,_,d,h){var f=[["attributes","Attributes","Attributes"],["focus_physicals","Physical Focus","Attributes"],["focus_mentals","Mental Focus","Attributes"],["focus_socials","Social Focus","Attributes"],["health_levels","Health Levels","Expended"],["willpower_sources","Willpower","Expended"],["skills","Skills","Skills"],["lore_specializations","Lore Specializations","Skills"],["academics_specializations","Academics Specializations","Skills"],["drive_specializations","Drive Specializations","Skills"],["linguistics_specializations","Languages","Skills"],["disciplines","Disciplines","Disciplines"],["techniques","Techniques","Disciplines"],["elder_disciplines","Elder Disciplines","Disciplines"],["rituals","Rituals","Disciplines"],["extra_in_clan_disciplines","Extra In Clan Disciplines","Disciplines"],["paths","Path of Enlightenment/Humanity","Morality"],["backgrounds","Backgrounds","Backgrounds"],["haven_specializations","Haven Specializations","Backgrounds"],["contacts_specializations","Contacts Specializations","Backgrounds"],["allies_specializations","Allies Specializations","Backgrounds"],["sabbat_rituals","Sabbat Ritae","Backgrounds"],["vampiric_texts","Vampiric Texts","Backgrounds"],["influence_elite_specializations","Influence: Elite","Backgrounds"],["influence_underworld_specializations","Influence: Underworld","Backgrounds"],["status_traits","Sect Status","Backgrounds"],["merits","Merits","Merits and Flaws"],["flaws","Flaws","Merits and Flaws"]],p=["clan","archetype","sect","faction","title","antecedence"],g=["merits","flaws"],m=e.extend({get_sum_creation_categories:function(){return g},_update_creation:function(t,n,r){var a=this;return(e.contains(["merits","flaws"],t)||r)&&e.contains(["flaws","merits","focus_mentals","focus_physicals","focus_socials","attributes","skills","disciplines","backgrounds"],t)?i.Object.fetchAllIfNeeded([a.get("creation")]).then(function(s){var c=s[0],l=t+"_"+r+"_remaining",o=t+"_"+r+"_picks";if(c.addUnique(o,n),e.contains(["merits","flaws"],t)){var u=e.sum(c.get(o),"attributes.value");c.set(l,7-u)}else c.increment(l,-1);return i.Promise.as(a)}):i.Promise.as(a)},ensure_creation_rules_exist:function(){var e=this;if(e.has("creation"))return i.Object.fetchAllIfNeeded([e.get("creation")]).then(function(){return i.Promise.as(e)},function(e){console.log("ensure_creation_rules_exist",e)});var t=new a({owner:e,completed:!1,concept:!1,archetype:!1,clan:!1,attributes:!1,focuses:!1,skills_4_remaining:1,skills_3_remaining:2,skills_2_remaining:3,skills_1_remaining:4,backgrounds_3_remaining:1,backgrounds_2_remaining:1,backgrounds_1_remaining:1,disciplines_2_remaining:1,disciplines_1_remaining:2,attributes_7_remaining:1,attributes_5_remaining:1,attributes_3_remaining:1,focus_mentals_1_remaining:1,focus_socials_1_remaining:1,focus_physicals_1_remaining:1,merits_0_remaining:7,flaws_0_remaining:7,phase_1_finished:!1,initial_xp:30,phase_2_finished:!1});return t.save().then(function(t){return e.set("creation",t),e.add_experience_notation({reason:"Character Creation XP",alteration_earned:30,earned:30})}).then(function(t){return i.Promise.as(e)})},fetch_all_creation_elements:function(){var t=this;return t.ensure_creation_rules_exist().then(function(){var n=t.get("creation"),r=["flaws","merits","focus_mentals","focus_physicals","focus_socials","attributes","skills","backgrounds","disciplines"],a=[];return e.each(r,function(t){e.each(e.range(-1,10),function(i){var r=t+"_"+i+"_picks";a=e.union(n.get(r),a)})}),a=e.chain(a).flatten().without(void 0).filter(function(e){return e.id}).value(),i.Object.fetchAllIfNeeded(a).then(function(){return i.Promise.as(t)})})},all_simpletrait_categories:function(){return f},all_text_attributes:function(){return p},_raw_generation:function(){var t,i=this;return e.each(i.get("backgrounds"),function(e){"Generation"==e.get_base_name()&&(t=e.get("value"))}),t},generation:function(){return this._raw_generation()||1},has_generation:function(){return!e.isUndefined(this._raw_generation())},morality_merit:function(){var t=this,i="Humanity";return e.each(t.get("merits"),function(t){if(e.startsWith(t.get("name"),"Path of")){var n=e.words(t.get("name"));i=e.slice(n,2),i=i.join(" ")}}),i},morality:function(){var e=this;if(!e.has("paths"))return new n;var t=e.get("paths")[0];return t?t:new n({name:"Humanity",value:1})},calculate_trait_cost:function(e){var t=this;return t.VampireCosts.calculate_trait_cost(t,e)},calculate_trait_to_spend:function(e){var t=this,i=t.VampireCosts.calculate_trait_cost(t,e),n=e.get("cost")||0;return i-n},calculate_total_cost:function(){var t=this,n=["skills","backgrounds","disciplines","attributes","merits","rituals","techniques","elder_disciplines"],r={},a=e.chain(n).map(function(e){return t.get(e)}).flatten().without(void 0).value();return i.Object.fetchAllIfNeeded(a).then(function(n){return e.each(n,function(e){r[e.get("category")+"-"+e.get("name")]={trait:e,cost:t.calculate_trait_cost(e)}}),i.Promise.as(r)})},max_trait_value:function(e){return"skills"==e.get("category")?10:20},initialize_vampire_costs:function(){var t=this;return e.isUndefined(t.VampireCosts)?(t.VampireCosts=new o,t.VampireCosts.initialize().then(function(){return i.Promise.as(t)})):i.Promise.as(t)},get_in_clan_disciplines:function(){var e=this;return e.VampireCosts.get_in_clan_disciplines(e)}},_);e.extend(m,h);var v=i.Object.extend("Vampire",m);v.get_character=function(t,n,r){if(e.isUndefined(r)&&(r={_character:null}),n=n||[],e.isString(n)&&(n=[n]),null===r._character){var a=new i.Query(v);return a.include("portrait"),a.include("owner"),a.include("backgrounds"),a.include("extra_in_clan_disciplines"),a.get(t).then(function(e){return r._character=e,v.get_character(t,n,r)})}if(r._character.id!=t)return r._character.save().then(function(){return r._character=null,v.get_character(t,n,r)});if("all"==n&&(n=e.result(r._character,"all_simpletrait_categories",[]),n=e.map(n,function(e){return e[0]})),0!==n.length){var s=e.chain(n).map(function(e){return r._character.get(e)}).flatten().without(void 0).filter(function(e){return e.id}).value();return i.Object.fetchAllIfNeeded(s).done(function(){return v.get_character(t,[],r)})}return r._character.ensure_creation_rules_exist().then(function(e){return r._character.initialize_vampire_costs()}).then(function(e){return r._character.initialize_troupe_membership()})};var b=function(i){e.isUndefined(t)||e.isUndefined(t.mobile)||e.isUndefined(t.mobile.loading)?console.log("Progress: "+i):t.mobile.loading("show",{text:i,textVisible:!0})};return v.create=function(t){var n,r=new v,a=new i.ACL;return a.setPublicReadAccess(!1),a.setPublicWriteAccess(!1),a.setWriteAccess(i.User.current(),!0),a.setReadAccess(i.User.current(),!0),a.setRoleReadAccess("Administrator",!0),a.setRoleWriteAccess("Administrator",!0),r.setACL(a),b("Fetching patronage status"),d.get_latest_patronage(i.User.current()).then(function(n){var a={name:t,owner:i.User.current(),change_count:0};return n&&e.extend(a,{expiresOn:n.get("expiresOn")}),b("Saving base character"),r.save(a)}).then(function(){return b("Fetching character from server"),v.get_character(r.id)}).then(function(e){return n=e,b("Adding Humanity"),n.update_trait("Humanity",5,"paths",5,!0)}).then(function(){return b("Adding Healthy"),n.update_trait("Healthy",3,"health_levels",3,!0)}).then(function(){return b("Adding Injured"),n.update_trait("Injured",3,"health_levels",3,!0)}).then(function(){return b("Adding Incapacitated"),n.update_trait("Incapacitated",3,"health_levels",3,!0)}).then(function(){return b("Adding Willpower"),n.update_trait("Willpower",6,"willpower_sources",6,!0)}).then(function(){return b("Done!"),i.Promise.as(n)})},v.create_test_character=function(e){var e=e||"",t="karmacharactertest"+e+Math.random().toString(36).slice(2);return v.create(t)},v.all_simpletrait_categories=function(){return f},v.all_text_attributes=function(){return p},v});