define(["underscore","jquery","parse","../models/SimpleTrait","../models/VampireChange","../models/VampireCreation","../collections/VampireChangeCollection","../collections/ExperienceNotationCollection","../models/ExperienceNotation","../helpers/BNSMETV1_VampireCosts","../helpers/PromiseFailReport","../helpers/ExpirationMixin","../helpers/UserWreqr"],function(e,t,n,r,i,a,s,o,c,u,l,_,d){var g=e.extend({remove_trait:function(e){var t=this;return e.destroy().then(function(){var n={alteration_spent:(e.get("cost")||0)*-1,reason:"Removed "+e.get("name")};return t.remove(e.get("category"),e),t.increment("change_count"),t.add_experience_notation(n)})},ensure_category:function(e){this.has(e)||this.set(e,[])},_update_creation:function(t,r,i){var a=this;return(e.contains(["merits","flaws"],t)||i)&&e.contains(["flaws","merits","focus_mentals","focus_physicals","focus_socials","attributes","skills","disciplines","backgrounds"],t)?n.Object.fetchAllIfNeeded([a.get("creation")]).then(function(s){var o=s[0],c=t+"_"+i+"_remaining",u=t+"_"+i+"_picks";if(o.addUnique(u,r),e.contains(["merits","flaws"],t)){var l=e.sum(o.get(u),"attributes.value");o.set(c,7-l)}else o.increment(c,-1);return n.Promise.as(a)}):n.Promise.as(a)},get_troupe_ids:function(){return this.troupe_ids},get_me_acl:function(){var t=this,r=new n.ACL;r.setPublicReadAccess(!1),r.setPublicWriteAccess(!1);var i=t.get("owner");return e.isUndefined(i)?(r.setReadAccess(n.User.current(),!0),r.setWriteAccess(n.User.current(),!0)):(r.setReadAccess(i,!0),r.setWriteAccess(i,!0)),r.setRoleReadAccess("Administrator",!0),r.setRoleWriteAccess("Administrator",!0),e.each(t.troupe_ids,function(e){r.setRoleReadAccess("LST_"+e,!0),r.setRoleWriteAccess("LST_"+e,!0),r.setRoleReadAccess("AST_"+e,!0),r.setRoleWriteAccess("AST_"+e,!0)}),r},set_cached_acl:function(e){var t=this;e=e||t.get_me_acl(),t.set("acl_to_json",JSON.stringify(e.toJSON()))},get_category_for_fetch:function(t){var n=this,r=n.get(t);return e.filter(r,function(t){return!e.isUndefined(t.id)})},update_trait:function(t,i,a,s,o){var c,u,_=this;return e.isString(t)?u=t:(c=t,a=c.get("category"),o=!0),_.ensure_category(a),n.Object.fetchAllIfNeeded(_.get_category_for_fetch(a)).then(function(){if(e.isString(t)){c=new r,e.each(_.get(a),function(t){e.isEqual(t.get("name"),u)&&(c=t)}),c.setACL(_.get_me_acl());var d=n.Object.extend("Vampire");c.set({name:u,value:s||i,category:a,owner:new d({id:_.id}),free_value:s||0})}else{if(!e.contains(_.get(a),c))return n.Promise.error({code:0,message:"Provided trait not already in Vampire as expected"});if(c.dirty("name")){var g=e.select(e.without(_.get(a),c),"attributes.name",c.get("name"));if(0!=g.length)try{return c.set("name",c._serverData.name),n.Promise.error({code:1,message:"Name matches an existing trait. Restoring original name"})}catch(h){return n.Promise.error({code:2,message:"Name matches an existing trait. Failed to restore original name. "+h})}}}var p=_.calculate_trait_cost(c),f=_.calculate_trait_to_spend(c);e.isFinite(f)||(f=0),c.set("cost",p),_.increment("change_count"),_.addUnique(a,c);var m,v=_._update_creation(a,c,s).then(function(){return 0!=f?_.add_experience_notation({alteration_spent:f,reason:"Update "+c.get("name")+" to "+c.get("value")}):_.save()}).then(function(){return console.log("Finished saving vampire"),n.Promise.as(_)}).fail(function(e){console.log("Failing to save vampire because of "+JSON.stringify(e)),l(e)});return m=o?v:n.Promise.as(_),m.then(function(){return _.trigger("change:"+a),n.Promise.as(c,_)})})},update_text:function(e,t){var r=this;return r.set(e,t),r.save().then(function(){return n.Object.fetchAllIfNeeded([r.get("creation")]).then(function(t){var i=t[0];return i.get(e)?n.Promise.as(r):(i.set(e,!0),i.save().then(function(){return n.Promise.as(r)}))})}).fail(l)},get_trait_by_name:function(t,r){var i=this,a=i.get(t);r=""+r;var s=e.find(a,"attributes.name",r);return n.Promise.as(s,i)},get_trait:function(t,r){var i=this,a=i.get(t);e.isObject(r)&&(r=r.id||r.cid);var s=e.findWhere(a,{cid:r});if(s)return n.Promise.as(s,i);s=e.findWhere(a,{id:r});try{var o=n.Object.fetchAllIfNeeded([s])}catch(c){return c instanceof TypeError?(console.log("Caught a typeerror indicating this object is still saving "+c.message),console.log(JSON.stringify(s)),console.log(JSON.stringify(a)),s.save().then(function(e){return n.Promise.as(e,i)})):n.Promise.reject(c)}return o.then(function(e){return n.Promise.as(e[0],i)})},ensure_creation_rules_exist:function(){var e=this;if(e.has("creation"))return n.Object.fetchAllIfNeeded([e.get("creation")]).then(function(){return n.Promise.as(e)},function(e){console.log("ensure_creation_rules_exist",e)});var t=new a({owner:e,completed:!1,concept:!1,archetype:!1,clan:!1,attributes:!1,focuses:!1,skills_4_remaining:1,skills_3_remaining:2,skills_2_remaining:3,skills_1_remaining:4,backgrounds_3_remaining:1,backgrounds_2_remaining:1,backgrounds_1_remaining:1,disciplines_2_remaining:1,disciplines_1_remaining:2,attributes_7_remaining:1,attributes_5_remaining:1,attributes_3_remaining:1,focus_mentals_1_remaining:1,focus_socials_1_remaining:1,focus_physicals_1_remaining:1,merits_0_remaining:7,flaws_0_remaining:7,phase_1_finished:!1,initial_xp:30,phase_2_finished:!1});return t.save().then(function(t){return e.set("creation",t),e.add_experience_notation({reason:"Character Creation XP",alteration_earned:30,earned:30})}).then(function(t){return n.Promise.as(e)})},fetch_all_creation_elements:function(){var t=this;return t.ensure_creation_rules_exist().then(function(){var r=t.get("creation"),i=["flaws","merits","focus_mentals","focus_physicals","focus_socials","attributes","skills","backgrounds","disciplines"],a=[];return e.each(i,function(t){e.each(e.range(-1,10),function(n){var i=t+"_"+n+"_picks";a=e.union(r.get(i),a)})}),a=e.chain(a).flatten().without(void 0).filter(function(e){return e.id}).value(),n.Object.fetchAllIfNeeded(a).then(function(){return n.Promise.as(t)})})},all_simpletrait_categories:function(){return[["attributes","Attributes","Attributes"],["focus_physicals","Physical Focus","Attributes"],["focus_mentals","Mental Focus","Attributes"],["focus_socials","Social Focus","Attributes"],["health_levels","Health Levels","Expended"],["willpower_sources","Willpower","Expended"],["skills","Skills","Skills"],["lore_specializations","Lore Specializations","Skills"],["academics_specializations","Academics Specializations","Skills"],["drive_specializations","Drive Specializations","Skills"],["linguistics_specializations","Languages","Skills"],["disciplines","Disciplines","Disciplines"],["techniques","Techniques","Disciplines"],["elder_disciplines","Elder Disciplines","Disciplines"],["rituals","Rituals","Disciplines"],["extra_in_clan_disciplines","Extra In Clan Disciplines","Disciplines"],["paths","Path of Enlightenment/Humanity","Morality"],["backgrounds","Backgrounds","Backgrounds"],["haven_specializations","Haven Specializations","Backgrounds"],["contacts_specializations","Contacts Specializations","Backgrounds"],["allies_specializations","Allies Specializations","Backgrounds"],["sabbat_rituals","Sabbat Ritae","Backgrounds"],["vampiric_texts","Vampiric Texts","Backgrounds"],["influence_elite_specializations","Influence: Elite","Backgrounds"],["influence_underworld_specializations","Influence: Underworld","Backgrounds"],["status_traits","Sect Status","Backgrounds"],["merits","Merits","Merits and Flaws"],["flaws","Flaws","Merits and Flaws"]]},unpick_from_creation:function(t,r,i,a){var s=this;return s.fetch_all_creation_elements().then(function(){return s.get_trait(t,r)}).then(function(r){var o=t+"_"+i+"_picks",c=t+"_"+i+"_remaining",u=s.get("creation");if(u.remove(o,r),e.contains(["merits","flaws"],t)){var l=e.sum(u.get(o),"attributes.value");u.set(c,7-l)}else u.increment(c,1);var _=n.Promise.when(u.save(),s.remove_trait(r));return a?_.then(function(){return n.Promise.as(s)}):n.Promise.as(s)})},is_being_created:function(){return!this.get("creation").get("completed")},complete_character_creation:function(){var e=this;return e.fetch_all_creation_elements().then(function(){var t=e.get("creation");return t.set("completed",!0),t.save()})},_raw_generation:function(){var t,n=this;return e.each(n.get("backgrounds"),function(e){"Generation"==e.get("name")&&(t=e.get("value"))}),t},generation:function(){return this._raw_generation()||1},has_generation:function(){return!e.isUndefined(this._raw_generation())},morality_merit:function(){var t=this,n="Humanity";return e.each(t.get("merits"),function(t){if(e.startsWith(t.get("name"),"Path of")){var r=e.words(t.get("name"));n=e.slice(r,2),n=n.join(" ")}}),n},morality:function(){var e=this;if(!e.has("paths"))return new r;var t=e.get("paths")[0];return t?t:new r({name:"Humanity",value:1})},health_levels:function(){var t=this,n=["Healthy","Injured","Incapacitated"],r={},i=[];return e.each(t.get("health_levels"),function(e){r[e.get("name")]=e.get("value")}),e.each(n,function(e){i.push([e,r[e]])}),i},experience_available:function(){var e=this;return e.get("experience_earned")-e.get("experience_spent")},get_experience_notations:function(t,r){var i=this;return e.isUndefined(i.experience_notations)?(i.experience_notations=new o,i.experience_notations.on("change",i.on_update_experience_notation,i),i.experience_notations.on("remove",i.on_remove_experience_notation,i),t&&t(i.experience_notations),i.fetch_experience_notations()):(t&&t(i.experience_notations),r&&r(i.experience_notations),n.Promise.as(i.experience_notations))},fetch_experience_notations:function(){var e=this;return e._experienceNotationsFetch=e._experienceNotationsFetch||n.Promise.as(),e._experienceNotationsFetch=e._experienceNotationsFetch.always(function(){var t=new n.Query(c);return t.equalTo("owner",e).addDescending("entered").addDescending("createdAt"),e.experience_notations.query=t,e.experience_notations.fetch({reset:!0})}),e._experienceNotationsFetch},wait_on_current_experience_update:function(){var e=this;return e._propagateExperienceUpdate||n.Promise.as()},_finalize_triggered_experience_notation_changes:function(t,r){var i=this,a=i._propagate_experience_notation_change(i.experience_notations,t);return i._propagateExperienceUpdate=i._propagateExperienceUpdate||n.Promise.as(),i._propagateExperienceUpdate=i._propagateExperienceUpdate.done(function(){return n.Object.saveAll(a)}).done(function(){i.trigger("finish_experience_notation_propagation")}).fail(function(t){e.isArray(t)?e.each(t,function(e){console.log("Something failed"+e.message)}):console.log("error updating experience"+t.message)}),i._propagateExperienceUpdate},on_remove_experience_notation:function(e,t,n){var r=this;return r._finalize_triggered_experience_notation_changes(n.index,t)},on_update_experience_notation:function(e,t,r){var i,a=this,s=!1;n.Promise.as([]);r=r||{};var o=t.changes;return o.entered&&(s=!0,a.experience_notations.sort()),(o.alteration_earned||o.alteration_spent)&&(s=!0),s?(i=a.experience_notations.indexOf(e),a._finalize_triggered_experience_notation_changes(i,a.experience_notations)):n.Promise.as([])},_default_experience_notation:function(t){var n=this,r=e.defaults(t||{},{entered:new Date,reason:"Unspecified reason",earned:0,spent:0,alteration_earned:0,alteration_spent:0,owner:n}),i=new c(r);return i.setACL(n.get_me_acl()),i},_propagate_experience_notation_change:function(t,n){var r=this;r.trigger("begin_experience_notation_propagation");var i;i=n+1<t.models.length?t.at(n+1):r._default_experience_notation();var a=[],s=e.reduceRight(e.slice(t.models,0,n+1),function(e,t,n,r){var i=t.get("alteration_earned")+e.get("earned");t.set("earned",i,{silent:!0});var s=t.get("alteration_spent")+e.get("spent");return t.set("spent",s,{silent:!0}),a.push(t),t},i);return r.set("experience_earned",s.get("earned")),r.set("experience_spent",s.get("spent")),a.push(r),a},add_experience_notation:function(e){var t=this;return t.get_experience_notations().then(function(r){var i=t._default_experience_notation(e);r.add(i,{silent:!0});for(var a,s,o=0,c=r.models.length;o<c;o++)if(s=r.models[o],r._byCid[s.cid]){a=o;break}var u=t._propagate_experience_notation_change(r,a);return n.Object.saveAll(u).then(function(){s.trigger("add",s,r,{index:a}),t.trigger("finish_experience_notation_propagation")})})},remove_experience_notation:function(t,r){var r,t,i=this;r=r||{},t=e.isArray(t)?t.slice():[t];var a=t[0],s=a;return i.get_experience_notations().then(function(e){var t=e.indexOf(a);e.remove(a,{silent:!0});var r=i._propagate_experience_notation_change(e,t);return n.Promise.when(a.destroy(),n.Object.saveAll(r)).then(function(){s.trigger("remove",s,e,{index:t}),i.trigger("finish_experience_notation_propagation")})})},get_recorded_changes:function(t){var n=this;if(!e.isUndefined(n.recorded_changes)){var r=n.update_recorded_changes();return t&&r.then(function(e){t(e)}),r}return n.recorded_changes=new s,n.on("saved",n.update_recorded_changes,n),t&&t(n.recorded_changes),n.fetch_recorded_changes()},update_recorded_changes:function(){var t=this;return 0==t.recorded_changes.models.length?t.fetch_recorded_changes():(t._recordedChangesFetch=t._recordedChangesFetch||n.Promise.as(),t._recordedChangesFetch=t._recordedChangesFetch.always(function(){var r=e.last(t.recorded_changes.models).createdAt,a=new n.Query(i);return a.equalTo("owner",t).addAscending("createdAt").limit(1e3),a.greaterThan("createdAt",r),t.recorded_changes.query=a,t.recorded_changes.fetch({add:!0})}),t._recordedChangesFetch)},fetch_recorded_changes:function(){var e=this;return e._recordedChangesFetch=e._recordedChangesFetch||n.Promise.as(),e._recordedChangesFetch=e._recordedChangesFetch.always(function(){console.log("Resetting recorded changes");var t=new n.Query(i);return t.equalTo("owner",e).addAscending("createdAt").limit(1e3),e.recorded_changes.query=t,e.recorded_changes.fetch({reset:!0})}),e._recordedChangesFetch},calculate_trait_cost:function(e){var t=this;return t.VampireCosts.calculate_trait_cost(t,e)},calculate_trait_to_spend:function(e){var t=this,n=t.VampireCosts.calculate_trait_cost(t,e),r=e.get("cost")||0;return n-r},calculate_total_cost:function(){var t=this,r=["skills","backgrounds","disciplines","attributes","merits","rituals","techniques","elder_disciplines"],i={},a=e.chain(r).map(function(e){return t.get(e)}).flatten().without(void 0).value();return n.Object.fetchAllIfNeeded(a).then(function(r){return e.each(r,function(e){i[e.get("category")+"-"+e.get("name")]={trait:e,cost:t.calculate_trait_cost(e)}}),n.Promise.as(i)})},get_transformed:function(t){var n=!e.isUndefined(this.troupes),i=this.clone();n&&(this.troupes.parent=null);var a=[];return e.each(t,function(t){if("core"!=t.get("category")){var n=t.get("category"),s=e.find(i.get(n),function(n){return e.isUndefined(n)&&console.log("Something went wrong fetching the full character object and now a name is undefined"),e.isEqual(n.get("name"),t.get("name"))}),o=new r({name:t.get("old_text")||t.get("name"),free_value:t.get("free_value"),value:t.get("old_value")||t.get("value"),cost:t.get("old_cost")||t.get("cost"),category:t.get("category")});"update"==t.get("type")?(i.set(n,e.xor(i.get(n),[s,o])),a.push({category:n,name:t.get("name"),fake:o,type:"changed"})):"define"==t.get("type")?(i.set(n,e.without(i.get(n),s)),a.push({category:n,name:o.get("name"),fake:void 0,type:"define"})):"remove"==t.get("type")&&(i.set(n,e.union(i.get(n),[o])),a.push({category:n,name:o.get("name"),fake:o,type:"removed"}))}else"core_define"==t.get("type")?(i.set(t.get("name"),void 0),a.push({category:t.get("category"),name:t.get("name"),old_text:void 0,type:"define"})):"core_update"==t.get("type")&&(i.set(t.get("name"),t.get("old_text")),a.push({category:t.get("category"),name:t.get("name"),old_text:t.get("old_text"),type:"update"}))}),i.transform_description=a,i},max_trait_value:function(e){return"skills"==e.get("category")?10:20},get_sorted_skills:function(){var t=this,n=t.get("skills");return n=e.sortBy(n,"attributes.name")},get_grouped_skills:function(t,n){var r=this,t=t||r.get_sorted_skills(),n=n||3,i={0:[],1:[],2:[]},a=e.ceil(t.length/n);return e.each(e.range(n),function(n){i[n]=e.take(t,a),t=e.drop(t,a)}),i=e.zip(i[0],i[1],i[2])},initialize_vampire_costs:function(){var t=this;return e.isUndefined(t.VampireCosts)?(t.VampireCosts=new u,t.VampireCosts.initialize().then(function(){return n.Promise.as(t)})):n.Promise.as(t)},get_in_clan_disciplines:function(){var e=this;return e.VampireCosts.get_in_clan_disciplines(e)},get_thumbnail:function(e){var t=this;if(t.get("portrait")){var r=t.get("portrait");return r.fetch().then(function(r){return console.log(t.get_thumbnail_sync(e)),n.Promise.as(r.get("thumb_"+e).url())})}return n.Promise.as("head_skull.png")},get_thumbnail_sync:function(t){var n=this;return e.result(n,"attributes.portrait.attributes.thumb_"+t+".url","head_skull.png")},get_willpower_total:function(){var t=this,n=t.get("willpower_sources"),r=e.sum(n,"attributes.value");return r},archive:function(){var e=this;return e.unset("owner"),e.save()},initialize_troupe_membership:function(){var t=this;t.troupe_ids=[],e.isUndefined(t.troupes)?(t.troupes=t.relation("troupes"),t.troupes.targetClassName="Troupe"):e.isNull(t.troupes.parent)&&(t.troupes.parent=t);var r=t.troupes.query();return r.each(function(e){t.troupe_ids.push(e.id)}).then(function(){return n.Promise.as(t)})},broken_update_troupe_acls:function(){var e=this,r=[],i=e.get_me_acl();return t.mobile.loading("show",{text:"Updating character permissions",textVisible:!0}),e.set_cached_acl(i),e.setACL(i),e.save().then(function(){t.mobile.loading("show",{text:"Updating trait permissions",textVisible:!0});var i=new n.Query("SimpleTrait");return i.equalTo("owner",e),i.each(function(t){t.setACL(e.get_me_acl()),r.push(t)})}).then(function(){return t.mobile.loading("show",{text:"Saving trait permissions",textVisible:!0}),n.Object.saveAll(r)}).then(function(){return t.mobile.loading("show",{text:"Fetching experience notations",textVisible:!0}),n.Promise.error()}).then(function(r){return t.mobile.loading("show",{text:"Updating experience notations",textVisible:!0}),r.each(function(t){t.setACL(e.get_me_acl())}),n.Object.saveAll(r.models)}).then(function(){return t.mobile.loading("show",{text:"Updating server side change log",textVisible:!0}),n.Cloud.run("update_vampire_change_permissions_for",{character:e.id})})},progress:function(n){e.isUndefined(t)||e.isUndefined(t.mobile)||e.isUndefined(t.mobile.loading)?console.log("Progress: "+n):t.mobile.loading("show",{text:n,textVisible:!0})},update_troupe_acls:function(){var e=this,t=[],r=e.get_me_acl();return e.progress("Updating character permissions"),e.set_cached_acl(r),e.setACL(r),e.save().then(function(){e.progress("Updating trait permissions"),delete e.attributes.troupes,delete e.troupes,delete e._previousAttributes.troupes,delete e._serverData.troupes;var r=new n.Query("SimpleTrait");return r.equalTo("owner",e),r.each(function(n){n.setACL(e.get_me_acl()),t.push(n)})}).then(function(){return e.progress("Saving trait permissions"),n.Object.saveAll(t)}).then(function(){return e.progress("Fetching experience notations"),e.get_experience_notations()}).then(function(t){return e.progress("Updating experience notations"),t.each(function(t){t.setACL(e.get_me_acl())}),n.Object.saveAll(t.models)}).then(function(){return e.progress("Updating server side change log"),n.Cloud.run("update_vampire_change_permissions_for",{character:e.id})}).then(function(){return e.progress("Finishing up!"),n.Promise.as(e)})},join_troupe:function(e){var t=this;return t.initialize_troupe_membership().then(function(){return t.troupes.add(e),t.troupe_ids.push(e.id),t.update_troupe_acls()})},leave_troupe:function(t){var n=this;return n.initialize_troupe_membership().then(function(){return n.troupes.remove(t),n.troupe_ids=e.remove(n.troupe_ids,t.id),n.update_troupe_acls()})},get_owned_ids:function(){var t=this,r={SimpleTrait:[],ExperienceNotation:[],VampireChange:[]},i=t;return n.Promise.when(e.map(["SimpleTrait","ExperienceNotation","VampireChange"],function(e){var t=new n.Query(e).equalTo("owner",i).select("id");return t.each(function(t){r[e].push(t.id)})})).then(function(){return n.Promise.as(r)})},update_server_client_permissions_mismatch:function(){var t=this;return t._mismatchFetch=t._mismatchFetch||n.Promise.as(),t._mismatchFetch=t._mismatchFetch.always(function(){return n.Promise.when(t.get_owned_ids(),n.Cloud.run("get_expected_vampire_ids",{character:t.id})).then(function(r,i){return e.eq(r,i)?t.is_mismatched=!1:t.is_mismatched=!0,n.Promise.as(t)})}),t._mismatchFetch},check_server_client_permissions_mismatch:function(){return e.isUndefined(this.is_mismatched)?this.update_server_client_permissions_mismatch():n.Promise.as(this)}},_),h=n.Object.extend("Vampire",g);h.get_character=function(t,r,i){if(e.isUndefined(i)&&(i={_character:null}),r=r||[],e.isString(r)&&(r=[r]),null===i._character){var a=new n.Query(h);return a.include("portrait"),a.include("owner"),a.include("backgrounds"),a.include("extra_in_clan_disciplines"),a.get(t).then(function(e){return i._character=e,h.get_character(t,r,i)})}if(i._character.id!=t)return i._character.save().then(function(){return i._character=null,h.get_character(t,r,i)});if("all"==r&&(r=e.result(i._character,"all_simpletrait_categories",[]),r=e.map(r,function(e){return e[0]})),0!==r.length){var s=e.chain(r).map(function(e){return i._character.get(e)}).flatten().without(void 0).filter(function(e){return e.id}).value();return n.Object.fetchAllIfNeeded(s).done(function(){return h.get_character(t,[],i)})}return i._character.ensure_creation_rules_exist().then(function(e){return i._character.initialize_vampire_costs()}).then(function(e){return i._character.initialize_troupe_membership()})};var p=function(n){e.isUndefined(t)||e.isUndefined(t.mobile)||e.isUndefined(t.mobile.loading)?console.log("Progress: "+n):t.mobile.loading("show",{text:n,textVisible:!0})};return h.create=function(t){var r,i=new h,a=new n.ACL;return a.setPublicReadAccess(!1),a.setPublicWriteAccess(!1),a.setWriteAccess(n.User.current(),!0),a.setReadAccess(n.User.current(),!0),a.setRoleReadAccess("Administrator",!0),a.setRoleWriteAccess("Administrator",!0),i.setACL(a),p("Fetching patronage status"),d.get_latest_patronage(n.User.current()).then(function(r){var a={name:t,owner:n.User.current(),change_count:0};return r&&e.extend(a,{expiresOn:r.get("expiresOn")}),p("Saving base character"),i.save(a)}).then(function(){return p("Fetching character from server"),h.get_character(i.id)}).then(function(e){return r=e,p("Adding Humanity"),r.update_trait("Humanity",5,"paths",5,!0)}).then(function(){return p("Adding Healthy"),r.update_trait("Healthy",3,"health_levels",3,!0)}).then(function(){return p("Adding Injured"),r.update_trait("Injured",3,"health_levels",3,!0)}).then(function(){return p("Adding Incapacitated"),r.update_trait("Incapacitated",3,"health_levels",3,!0)}).then(function(){return p("Adding Willpower"),r.update_trait("Willpower",6,"willpower_sources",6,!0)}).then(function(){return p("Done!"),n.Promise.as(r)})},h.create_test_character=function(e){var e=e||"",t="karmacharactertest"+e+Math.random().toString(36).slice(2);return h.create(t)},h});